{% extends "admin/base.html" %}

{% block title %}Auto Post - Advanced SEO{% endblock %}
{% block page_title %}Auto Post - Advanced SEO{% endblock %}

{% block content %}
<link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">

<div class="auto-post-container">
    <div class="card mode-toggle-card">
        <h3>Post Mode</h3>
        <div class="mode-toggle">
            <button type="button" class="mode-btn active" data-mode="manual">
                <i class="fas fa-edit"></i> Manual
            </button>
            <button type="button" class="mode-btn" data-mode="auto">
                <i class="fas fa-magic"></i> Auto
            </button>
        </div>
        <p class="mode-description" id="modeDescription">
            <strong>Manual Mode:</strong> Manually enter all post details, SEO settings, and select match.
        </p>
    </div>

    <div id="autoModeSection" class="auto-mode-section" style="display: none;">
        <div class="card">
            <h3><i class="fas fa-calendar-alt"></i> Select Match for Auto Post</h3>
            <p class="info-text">Select a match - Title, Meta, Keywords, and Content will be generated automatically!</p>
            
            <div class="form-group">
                <label for="autoMatchDate">Filter by Date</label>
                <input type="date" id="autoMatchDate" class="date-filter">
            </div>
            
            <div class="match-type-selector">
                <button type="button" class="match-type-btn-auto" data-type="live">Live</button>
                <button type="button" class="match-type-btn-auto active" data-type="upcoming">Upcoming</button>
                <button type="button" class="match-type-btn-auto" data-type="recent">Recent</button>
            </div>
            
            <div class="matches-container" id="autoMatchesContainer">
                <div class="loading">Loading matches...</div>
            </div>
            
            <div id="autoSelectedMatchInfo" class="selected-match-info"></div>
            
            <div id="autoGeneratedPreview" class="auto-generated-preview" style="display: none;">
                <h4><i class="fas fa-eye"></i> Auto Generated Preview</h4>
                <div class="preview-item">
                    <label>Title:</label>
                    <span id="previewTitle"></span>
                </div>
                <div class="preview-item">
                    <label>Meta Title:</label>
                    <span id="previewMetaTitle"></span>
                </div>
                <div class="preview-item">
                    <label>Keywords:</label>
                    <span id="previewKeywords"></span>
                </div>
                <div class="preview-item">
                    <label>Slug:</label>
                    <span id="previewSlug"></span>
                </div>
            </div>
            
            <div class="form-group" style="margin-top: 20px;">
                <label><input type="checkbox" id="autoPublish" checked> Publish Immediately</label>
            </div>
            <div class="form-group">
                <label><input type="checkbox" id="autoFeatured"> Featured Post</label>
            </div>
            
            <button type="button" class="btn btn-primary btn-block btn-lg" id="createAutoPostBtn" disabled>
                <i class="fas fa-bolt"></i> Create Auto Post
            </button>
        </div>
    </div>

    <form id="autoPostForm">
        <div class="form-layout" id="manualModeSection">
            <div class="main-content">
                <div class="card">
                    <h3>Post Details</h3>
                    <div class="form-group">
                        <label for="title">Post Title *</label>
                        <input type="text" id="title" name="title" required placeholder="IND vs NZ Live Score Today - Dream11 Prediction">
                    </div>
                    
                    <div class="form-group">
                        <label for="slug">URL Slug *</label>
                        <div class="slug-preview">
                            <span class="slug-prefix">/post/</span>
                            <input type="text" id="slug" name="slug" required placeholder="ind-vs-nz-live-score-dream11">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Content</label>
                        <div id="editor"></div>
                        <input type="hidden" id="content" name="content">
                    </div>
                    
                    <div class="form-group">
                        <label for="excerpt">Excerpt (Short Description)</label>
                        <textarea id="excerpt" name="excerpt" rows="3" placeholder="Get live score, dream11 team prediction, pitch report for today's match..."></textarea>
                    </div>
                </div>
                
                <div class="card">
                    <h3>Live Match Scorecard</h3>
                    <p class="info-text">Select a match to embed real-time scorecard in your post. Scorecard will update automatically when users view the post.</p>
                    
                    <div class="manual-match-id">
                        <div class="manual-id-input">
                            <input type="text" id="manualMatchId" placeholder="Enter Match ID (e.g. 125025)">
                            <button type="button" class="btn btn-secondary" id="searchMatchBtn">Search</button>
                        </div>
                        <div id="manualMatchResult" class="manual-match-result"></div>
                    </div>
                    
                    <div class="divider-or"><span>OR</span></div>
                    
                    <div class="match-type-selector">
                        <button type="button" class="match-type-btn" data-type="live">Live Matches</button>
                        <button type="button" class="match-type-btn" data-type="upcoming">Upcoming Matches</button>
                        <button type="button" class="match-type-btn active" data-type="recent">Recent Matches</button>
                    </div>
                    
                    <div class="matches-container" id="matchesContainer">
                        <div class="loading">Loading matches...</div>
                    </div>
                    
                    <input type="hidden" id="match_id" name="match_id">
                    <div id="selectedMatchInfo" class="selected-match-info"></div>
                </div>
            </div>
            
            <div class="sidebar-content">
                <div class="card">
                    <h3>Publish</h3>
                    <div class="form-group">
                        <label><input type="checkbox" id="is_published" name="is_published"> Published</label>
                    </div>
                    <div class="form-group">
                        <label><input type="checkbox" id="is_featured" name="is_featured"> Featured Post</label>
                    </div>
                    <button type="submit" class="btn btn-primary btn-block">Create Post</button>
                </div>
                
                <div class="card">
                    <h3>Category</h3>
                    <div class="form-group">
                        <select id="category_id" name="category_id">
                            <option value="">Select Category</option>
                            {% for cat in categories %}
                            <option value="{{ cat.id }}" {% if cat.slug == 'today-live-match' %}selected{% endif %}>{{ cat.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                
                <div class="card seo-card">
                    <h3>Advanced SEO Settings</h3>
                    
                    <div class="form-group">
                        <label for="meta_title">Meta Title</label>
                        <input type="text" id="meta_title" name="meta_title" placeholder="IND vs NZ Live Score | Dream11 Team Today">
                        <div class="seo-meter">
                            <div class="meter-bar" id="titleMeter"></div>
                        </div>
                        <small><span id="metaTitleCount">0</span>/60 characters - Google displays 50-60</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="meta_description">Meta Description</label>
                        <textarea id="meta_description" name="meta_description" rows="3" placeholder="Get IND vs NZ live score updates, dream11 team prediction, pitch report, playing 11 and match preview for today's T20 match..."></textarea>
                        <div class="seo-meter">
                            <div class="meter-bar" id="descMeter"></div>
                        </div>
                        <small><span id="metaDescCount">0</span>/160 characters - Google displays 150-160</small>
                    </div>
                    
                    <div class="form-group">
                        <label>Meta Keywords (Multiple)</label>
                        <div class="keywords-container" id="keywordsContainer">
                            <div class="keywords-input-wrapper">
                                <input type="text" id="keywordInput" placeholder="Type keyword and press Enter">
                                <button type="button" class="btn-add-keyword" id="addKeywordBtn">+</button>
                            </div>
                            <div class="keywords-tags" id="keywordsTags"></div>
                            <input type="hidden" id="meta_keywords" name="meta_keywords">
                        </div>
                        <div class="suggested-keywords">
                            <strong>Suggested Keywords:</strong>
                            <div class="keyword-suggestions">
                                <span class="suggestion" data-keyword="IND vs NZ live score">IND vs NZ live score</span>
                                <span class="suggestion" data-keyword="IND vs NZ dream11 team">IND vs NZ dream11 team</span>
                                <span class="suggestion" data-keyword="today match prediction">today match prediction</span>
                                <span class="suggestion" data-keyword="pitch report">pitch report</span>
                                <span class="suggestion" data-keyword="playing 11 today">playing 11 today</span>
                                <span class="suggestion" data-keyword="live cricket score">live cricket score</span>
                                <span class="suggestion" data-keyword="match preview">match preview</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="focus_keyword">Focus Keyword</label>
                        <input type="text" id="focus_keyword" name="focus_keyword" placeholder="IND vs NZ live score">
                        <small>Main keyword for SEO optimization</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="canonical_url">Canonical URL</label>
                        <input type="text" id="canonical_url" name="canonical_url" placeholder="https://...">
                    </div>
                </div>
                
                <div class="card">
                    <h3>Open Graph (Social Media)</h3>
                    <div class="form-group">
                        <label for="og_title">OG Title</label>
                        <input type="text" id="og_title" name="og_title" placeholder="Share title for Facebook/Twitter">
                    </div>
                    <div class="form-group">
                        <label for="og_description">OG Description</label>
                        <textarea id="og_description" name="og_description" rows="2" placeholder="Share description for social media"></textarea>
                    </div>
                </div>
                
                <div class="card">
                    <h3>Thumbnail</h3>
                    <div class="thumbnail-preview" id="thumbPreview">
                        <span>No image selected</span>
                    </div>
                    <input type="file" id="thumbnailFile" accept="image/*" style="display:none">
                    <input type="hidden" id="thumbnail" name="thumbnail">
                    <button type="button" class="btn btn-secondary btn-block" onclick="document.getElementById('thumbnailFile').click()">Upload Image</button>
                </div>
                
                <div class="card">
                    <h3>Author</h3>
                    <div class="form-group">
                        <input type="text" id="author" name="author" value="Admin" placeholder="Author name">
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<style>
.auto-post-container { padding: 20px; }
.form-layout { display: grid; grid-template-columns: 1fr 350px; gap: 20px; }

.mode-toggle-card { margin-bottom: 20px; }
.mode-toggle { display: flex; gap: 10px; margin-bottom: 15px; }
.mode-btn { flex: 1; padding: 15px 20px; border: 2px solid var(--admin-border); background: var(--admin-card); color: var(--admin-text); border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 16px; transition: all 0.3s; display: flex; align-items: center; justify-content: center; gap: 10px; }
.mode-btn:hover { border-color: var(--admin-accent); }
.mode-btn.active { background: var(--admin-accent); color: #fff; border-color: var(--admin-accent); }
.mode-btn i { font-size: 18px; }
.mode-description { padding: 12px; background: var(--admin-input-bg); border-radius: 6px; color: var(--admin-text-muted); font-size: 14px; margin: 0; border-left: 4px solid var(--admin-accent); }

.auto-mode-section { margin-bottom: 20px; }
.date-filter { padding: 12px; border: 2px solid var(--admin-border); border-radius: 6px; background: var(--admin-input-bg); color: var(--admin-text); font-size: 14px; width: 100%; }
.date-filter:focus { border-color: var(--admin-accent); outline: none; }

.match-type-btn-auto { flex: 1; padding: 10px; border: 2px solid var(--admin-accent); background: var(--admin-card); color: var(--admin-accent); border-radius: 6px; cursor: pointer; font-weight: 600; transition: all 0.3s; }
.match-type-btn-auto.active { background: var(--admin-accent); color: #fff; }
.match-type-btn-auto:hover { background: var(--admin-accent-dark); color: #fff; }

.auto-generated-preview { margin-top: 20px; padding: 20px; background: #14532d; border-radius: 8px; border: 2px solid #166534; }
.auto-generated-preview h4 { margin: 0 0 15px 0; color: #4ade80; font-size: 16px; display: flex; align-items: center; gap: 8px; }
.preview-item { margin-bottom: 10px; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 4px; }
.preview-item label { display: block; font-size: 12px; color: #4ade80; margin-bottom: 4px; font-weight: 600; }
.preview-item span { color: #fff; font-size: 14px; }

.btn-lg { padding: 15px 30px; font-size: 16px; }
.btn-lg i { margin-right: 8px; }
#createAutoPostBtn:disabled { background: var(--admin-border); cursor: not-allowed; }
#createAutoPostBtn:not(:disabled) { animation: glow 2s infinite; }
@keyframes glow { 0%, 100% { box-shadow: 0 0 5px var(--admin-accent); } 50% { box-shadow: 0 0 20px var(--admin-accent); } }
.card { background: var(--admin-card); border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.3); padding: 20px; margin-bottom: 20px; border: 1px solid var(--admin-border); }
.card h3 { margin: 0 0 20px 0; color: var(--admin-accent); font-size: 16px; border-bottom: 2px solid var(--admin-accent); padding-bottom: 10px; }
.form-group { margin-bottom: 15px; }
.form-group label { display: block; margin-bottom: 5px; font-weight: 500; color: var(--admin-text); font-size: 14px; }
.form-group input[type="text"], .form-group textarea, .form-group select { width: 100%; padding: 10px; border: 1px solid var(--admin-border); border-radius: 4px; font-size: 14px; box-sizing: border-box; background: var(--admin-input-bg); color: var(--admin-text); }
.form-group input[type="checkbox"] { margin-right: 8px; accent-color: var(--admin-accent); }
.form-group small { display: block; margin-top: 4px; color: var(--admin-text-muted); font-size: 12px; }
.slug-preview { display: flex; align-items: center; }
.slug-prefix { background: var(--admin-input-bg); padding: 10px; border: 1px solid var(--admin-border); border-right: none; border-radius: 4px 0 0 4px; color: var(--admin-text-muted); font-size: 14px; }
.slug-preview input { border-radius: 0 4px 4px 0; }
.btn { padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; transition: all 0.3s; }
.btn-primary { background: var(--admin-accent); color: #fff; }
.btn-primary:hover { background: var(--admin-accent-dark); }
.btn-secondary { background: var(--admin-input-bg); color: var(--admin-text); border: 1px solid var(--admin-border); }
.btn-block { width: 100%; }
#editor { height: 300px; background: var(--admin-input-bg); border-radius: 0 0 4px 4px; color: var(--admin-text); }
.ql-toolbar { border-radius: 4px 4px 0 0; background: var(--admin-table-header); border-color: var(--admin-border) !important; }
.ql-toolbar .ql-stroke { stroke: var(--admin-text) !important; }
.ql-toolbar .ql-fill { fill: var(--admin-text) !important; }
.ql-toolbar .ql-picker { color: var(--admin-text) !important; }
.ql-container { border-radius: 0 0 4px 4px; font-size: 16px; border-color: var(--admin-border) !important; }
.ql-editor { color: var(--admin-text); }

.match-type-selector { display: flex; gap: 10px; margin-bottom: 15px; }
.match-type-btn { flex: 1; padding: 12px; border: 2px solid var(--admin-accent); background: var(--admin-card); color: var(--admin-accent); border-radius: 6px; cursor: pointer; font-weight: 600; transition: all 0.3s; }
.match-type-btn.active { background: var(--admin-accent); color: #fff; }
.match-type-btn:hover { background: var(--admin-accent-dark); color: #fff; }

.matches-container { max-height: 300px; overflow-y: auto; border: 1px solid var(--admin-border); border-radius: 6px; padding: 10px; background: var(--admin-input-bg); }
.match-item { display: flex; align-items: center; padding: 12px; border: 2px solid var(--admin-border); border-radius: 6px; margin-bottom: 8px; cursor: pointer; transition: all 0.3s; background: var(--admin-card); }
.match-item:hover { border-color: var(--admin-accent); }
.match-item.selected { border-color: var(--admin-accent); background: #14532d; }
.match-item .teams { flex: 1; color: var(--admin-text); }
.match-item .team { display: flex; align-items: center; gap: 8px; margin: 4px 0; }
.match-item .vs { color: var(--admin-text-muted); font-size: 12px; margin: 2px 0; }
.match-item .status { padding: 4px 10px; border-radius: 4px; font-size: 12px; font-weight: 600; }
.match-item .status.live { background: #dc2626; color: #fff; animation: pulse 1.5s infinite; }
.match-item .status.upcoming { background: #2563eb; color: #fff; }
.match-item .status.recent { background: #16a34a; color: #fff; }
@keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }

.selected-match-info { padding: 15px; background: #14532d; border-radius: 6px; margin-top: 15px; display: none; border: 1px solid #166534; }
.selected-match-info.show { display: block; }
.selected-match-info strong { color: #4ade80; }

.info-text { color: var(--admin-text-muted); font-size: 14px; margin-bottom: 15px; padding: 10px; background: var(--admin-input-bg); border-radius: 4px; border-left: 4px solid var(--admin-accent); }

.seo-card { background: var(--admin-card); border: 1px solid var(--admin-border); }
.seo-meter { height: 4px; background: var(--admin-input-bg); border-radius: 2px; margin-top: 5px; overflow: hidden; }
.meter-bar { height: 100%; background: #16a34a; transition: width 0.3s, background 0.3s; width: 0; }
.meter-bar.warning { background: #f59e0b; }
.meter-bar.danger { background: #dc2626; }

.keywords-container { border: 1px solid var(--admin-border); border-radius: 4px; padding: 10px; background: var(--admin-input-bg); }
.keywords-input-wrapper { display: flex; gap: 8px; margin-bottom: 10px; }
.keywords-input-wrapper input { flex: 1; padding: 8px; border: 1px solid var(--admin-border); border-radius: 4px; background: var(--admin-card); color: var(--admin-text); }
.btn-add-keyword { width: 36px; height: 36px; background: var(--admin-accent); color: #fff; border: none; border-radius: 4px; font-size: 20px; cursor: pointer; }
.keywords-tags { display: flex; flex-wrap: wrap; gap: 8px; min-height: 30px; }
.keyword-tag { display: inline-flex; align-items: center; gap: 5px; background: var(--admin-accent); color: #fff; padding: 5px 10px; border-radius: 20px; font-size: 13px; }
.keyword-tag .remove { cursor: pointer; font-weight: bold; margin-left: 5px; }

.suggested-keywords { margin-top: 15px; padding: 10px; background: var(--admin-card); border-radius: 4px; border: 1px solid var(--admin-border); }
.suggested-keywords strong { display: block; margin-bottom: 8px; color: var(--admin-accent); font-size: 13px; }
.keyword-suggestions { display: flex; flex-wrap: wrap; gap: 8px; }
.suggestion { background: #14532d; color: #4ade80; padding: 5px 12px; border-radius: 20px; font-size: 12px; cursor: pointer; transition: all 0.3s; border: 1px solid #166534; }
.suggestion:hover { background: var(--admin-accent); color: #fff; }

.thumbnail-preview { width: 100%; height: 150px; background: var(--admin-input-bg); border-radius: 4px; display: flex; align-items: center; justify-content: center; margin-bottom: 10px; overflow: hidden; border: 1px solid var(--admin-border); }
.thumbnail-preview img { width: 100%; height: 100%; object-fit: cover; }

.loading { text-align: center; padding: 30px; color: #888; }
.no-matches { text-align: center; padding: 30px; color: #888; font-style: italic; }

.manual-match-id { margin-bottom: 15px; }
.manual-id-input { display: flex; gap: 10px; }
.manual-id-input input { flex: 1; padding: 12px; border: 2px solid var(--admin-border); border-radius: 6px; font-size: 14px; background: var(--admin-input-bg); color: var(--admin-text); }
.manual-id-input input:focus { border-color: var(--admin-accent); outline: none; }
.manual-id-input button { padding: 12px 20px; white-space: nowrap; }
.manual-match-result { margin-top: 10px; }
.manual-match-result .match-item { margin: 0; }
.manual-match-result .not-found { padding: 15px; background: #7f1d1d; color: #fca5a5; border-radius: 6px; text-align: center; }
.manual-match-result .searching { padding: 15px; color: var(--admin-text-muted); text-align: center; }

.divider-or { display: flex; align-items: center; margin: 20px 0; color: var(--admin-text-muted); }
.divider-or::before, .divider-or::after { content: ''; flex: 1; border-bottom: 1px solid var(--admin-border); }
.divider-or span { padding: 0 15px; font-size: 12px; font-weight: 600; text-transform: uppercase; }

@media (max-width: 1024px) {
    .form-layout { grid-template-columns: 1fr; }
}
</style>

<script src="https://cdn.quilljs.com/1.3.7/quill.min.js"></script>
<script>
var quill = new Quill('#editor', {
    theme: 'snow',
    modules: {
        toolbar: [
            [{ 'header': [1, 2, 3, 4, 5, 6, false] }],
            ['bold', 'italic', 'underline', 'strike'],
            [{ 'color': [] }, { 'background': [] }],
            [{ 'list': 'ordered'}, { 'list': 'bullet' }],
            [{ 'align': [] }],
            ['link', 'image'],
            ['blockquote'],
            ['clean']
        ]
    }
});

let keywords = [];
let selectedMatchId = null;

function loadMatches(type) {
    const container = document.getElementById('matchesContainer');
    container.innerHTML = '<div class="loading">Loading matches...</div>';
    
    fetch(`/api/live-matches?type=${type}`)
        .then(res => res.json())
        .then(data => {
            if (data.matches && data.matches.length > 0) {
                container.innerHTML = data.matches.map(match => `
                    <div class="match-item" data-match-id="${match.match_id}" data-match-title="${match.team1_name} vs ${match.team2_name}">
                        <div class="teams">
                            <div class="team">
                                <strong>${match.team1_name || 'TBA'}</strong>
                                <span>${match.team1_score || ''}</span>
                            </div>
                            <div class="vs">vs</div>
                            <div class="team">
                                <strong>${match.team2_name || 'TBA'}</strong>
                                <span>${match.team2_score || ''}</span>
                            </div>
                            <div style="font-size:12px;color:#666;margin-top:5px;">${match.series_name || match.match_format || ''}</div>
                        </div>
                        <span class="status ${type}">${type === 'live' ? 'LIVE' : (type === 'upcoming' ? 'UPCOMING' : 'RESULT')}</span>
                    </div>
                `).join('');
                
                document.querySelectorAll('.match-item').forEach(item => {
                    item.addEventListener('click', function() {
                        document.querySelectorAll('.match-item').forEach(i => i.classList.remove('selected'));
                        this.classList.add('selected');
                        selectedMatchId = this.dataset.matchId;
                        document.getElementById('match_id').value = selectedMatchId;
                        
                        const matchTitle = this.dataset.matchTitle;
                        document.getElementById('selectedMatchInfo').innerHTML = `
                            <strong>Selected Match:</strong> ${matchTitle}<br>
                            <small>Match ID: ${selectedMatchId} - Real-time scorecard will be shown in post</small>
                        `;
                        document.getElementById('selectedMatchInfo').classList.add('show');
                    });
                });
            } else {
                container.innerHTML = '<div class="no-matches">No matches found</div>';
            }
        })
        .catch(err => {
            container.innerHTML = '<div class="no-matches">Error loading matches</div>';
        });
}

document.querySelectorAll('.match-type-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        document.querySelectorAll('.match-type-btn').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        loadMatches(this.dataset.type);
    });
});

loadMatches('recent');

function searchMatchById() {
    const matchId = document.getElementById('manualMatchId').value.trim();
    const resultContainer = document.getElementById('manualMatchResult');
    
    if (!matchId) {
        resultContainer.innerHTML = '<div class="not-found">Please enter a Match ID</div>';
        return;
    }
    
    resultContainer.innerHTML = '<div class="searching">Searching...</div>';
    
    fetch(`/api/match/${matchId}`)
        .then(res => res.json())
        .then(data => {
            if (data.success && data.match) {
                const match = data.match;
                const stateClass = match.state === 'Live' ? 'live' : (match.state === 'Upcoming' ? 'upcoming' : 'recent');
                const stateLabel = match.state === 'Live' ? 'LIVE' : (match.state === 'Upcoming' ? 'UPCOMING' : 'RESULT');
                
                resultContainer.innerHTML = `
                    <div class="match-item selected" data-match-id="${match.match_id}" data-match-title="${match.team1_name} vs ${match.team2_name}">
                        <div class="teams">
                            <div class="team">
                                <strong>${match.team1_name || 'TBA'}</strong>
                                <span>${match.team1_score || ''}</span>
                            </div>
                            <div class="vs">vs</div>
                            <div class="team">
                                <strong>${match.team2_name || 'TBA'}</strong>
                                <span>${match.team2_score || ''}</span>
                            </div>
                            <div style="font-size:12px;color:#666;margin-top:5px;">${match.series_name || match.match_format || ''}</div>
                        </div>
                        <span class="status ${stateClass}">${stateLabel}</span>
                    </div>
                `;
                
                selectedMatchId = match.match_id;
                document.getElementById('match_id').value = selectedMatchId;
                document.getElementById('selectedMatchInfo').innerHTML = `
                    <strong>Selected Match:</strong> ${match.team1_name} vs ${match.team2_name}<br>
                    <small>Match ID: ${selectedMatchId} - Real-time scorecard will be shown in post</small>
                `;
                document.getElementById('selectedMatchInfo').classList.add('show');
                
                document.querySelectorAll('#matchesContainer .match-item').forEach(i => i.classList.remove('selected'));
            } else {
                resultContainer.innerHTML = '<div class="not-found">Match not found with this ID</div>';
            }
        })
        .catch(err => {
            resultContainer.innerHTML = '<div class="not-found">Error searching match</div>';
        });
}

document.getElementById('searchMatchBtn').addEventListener('click', searchMatchById);
document.getElementById('manualMatchId').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        e.preventDefault();
        searchMatchById();
    }
});

function addKeyword(keyword) {
    keyword = keyword.trim();
    if (keyword && !keywords.includes(keyword)) {
        keywords.push(keyword);
        renderKeywords();
    }
}

function removeKeyword(keyword) {
    keywords = keywords.filter(k => k !== keyword);
    renderKeywords();
}

function renderKeywords() {
    const container = document.getElementById('keywordsTags');
    container.innerHTML = keywords.map(k => `
        <span class="keyword-tag">${k}<span class="remove" onclick="removeKeyword('${k}')">&times;</span></span>
    `).join('');
    document.getElementById('meta_keywords').value = keywords.join(', ');
}

document.getElementById('keywordInput').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        e.preventDefault();
        addKeyword(this.value);
        this.value = '';
    }
});

document.getElementById('addKeywordBtn').addEventListener('click', function() {
    const input = document.getElementById('keywordInput');
    addKeyword(input.value);
    input.value = '';
});

document.querySelectorAll('.suggestion').forEach(s => {
    s.addEventListener('click', function() {
        addKeyword(this.dataset.keyword);
    });
});

document.getElementById('title').addEventListener('input', function() {
    const slug = this.value.toLowerCase()
        .replace(/[^a-z0-9\s-]/g, '')
        .replace(/\s+/g, '-')
        .replace(/-+/g, '-')
        .replace(/^-|-$/g, '');
    document.getElementById('slug').value = slug;
});

function updateMeter(input, meter, max) {
    const len = input.value.length;
    const percent = Math.min((len / max) * 100, 100);
    meter.style.width = percent + '%';
    meter.classList.remove('warning', 'danger');
    if (percent > 90) meter.classList.add('danger');
    else if (percent > 70) meter.classList.add('warning');
}

document.getElementById('meta_title').addEventListener('input', function() {
    document.getElementById('metaTitleCount').textContent = this.value.length;
    updateMeter(this, document.getElementById('titleMeter'), 60);
});

document.getElementById('meta_description').addEventListener('input', function() {
    document.getElementById('metaDescCount').textContent = this.value.length;
    updateMeter(this, document.getElementById('descMeter'), 160);
});

document.getElementById('thumbnailFile').addEventListener('change', async function(e) {
    const file = e.target.files[0];
    if (!file) return;
    
    const formData = new FormData();
    formData.append('file', file);
    
    try {
        const res = await fetch('/api/upload', { method: 'POST', body: formData });
        const result = await res.json();
        if (result.success) {
            document.getElementById('thumbnail').value = result.url;
            document.getElementById('thumbPreview').innerHTML = `<img src="${result.url}" alt="">`;
        } else {
            alert(result.message || 'Upload failed');
        }
    } catch (err) {
        alert('Upload error: ' + err.message);
    }
});

document.getElementById('autoPostForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    document.getElementById('content').value = quill.root.innerHTML;
    
    const formData = {
        title: document.getElementById('title').value,
        slug: document.getElementById('slug').value,
        content: document.getElementById('content').value,
        excerpt: document.getElementById('excerpt').value,
        thumbnail: document.getElementById('thumbnail').value,
        category_id: document.getElementById('category_id').value || null,
        match_id: document.getElementById('match_id').value || null,
        is_published: document.getElementById('is_published').checked,
        is_featured: document.getElementById('is_featured').checked,
        meta_title: document.getElementById('meta_title').value,
        meta_description: document.getElementById('meta_description').value,
        meta_keywords: document.getElementById('meta_keywords').value,
        canonical_url: document.getElementById('canonical_url').value,
        og_title: document.getElementById('og_title').value,
        og_description: document.getElementById('og_description').value,
        author: document.getElementById('author').value
    };
    
    try {
        const res = await fetch('/api/posts', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(formData)
        });
        const result = await res.json();
        if (result.success) {
            alert('Post created successfully!');
            window.location.href = '/admin/posts';
        } else {
            alert(result.message || 'Error saving post');
        }
    } catch (err) {
        alert('Error: ' + err.message);
    }
});

let currentMode = 'manual';
let autoSelectedMatch = null;

document.querySelectorAll('.mode-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        currentMode = this.dataset.mode;
        
        const autoSection = document.getElementById('autoModeSection');
        const manualSection = document.getElementById('manualModeSection');
        const modeDesc = document.getElementById('modeDescription');
        
        if (currentMode === 'auto') {
            autoSection.style.display = 'block';
            manualSection.style.display = 'none';
            modeDesc.innerHTML = '<strong>Auto Mode:</strong> Select a match and everything will be generated automatically - Title, Meta, Keywords, Content!';
            loadAutoMatches('upcoming');
        } else {
            autoSection.style.display = 'none';
            manualSection.style.display = 'grid';
            modeDesc.innerHTML = '<strong>Manual Mode:</strong> Manually enter all post details, SEO settings, and select match.';
        }
    });
});

function loadAutoMatches(type, dateFilter = null) {
    const container = document.getElementById('autoMatchesContainer');
    container.innerHTML = '<div class="loading">Loading matches...</div>';
    
    let url = `/api/live-matches?type=${type}`;
    if (dateFilter) {
        url += `&date=${dateFilter}`;
    }
    
    fetch(url)
        .then(res => res.json())
        .then(data => {
            if (data.matches && data.matches.length > 0) {
                let matches = data.matches;
                
                if (dateFilter) {
                    matches = matches.filter(m => {
                        if (m.start_time) {
                            const matchDate = new Date(m.start_time).toISOString().split('T')[0];
                            return matchDate === dateFilter;
                        }
                        return true;
                    });
                }
                
                if (matches.length === 0) {
                    container.innerHTML = '<div class="no-matches">No matches found for selected date</div>';
                    return;
                }
                
                container.innerHTML = matches.map(match => `
                    <div class="match-item" data-match='${JSON.stringify(match)}'>
                        <div class="teams">
                            <div class="team">
                                <strong>${match.team1_name || 'TBA'}</strong>
                                <span>${match.team1_score || ''}</span>
                            </div>
                            <div class="vs">vs</div>
                            <div class="team">
                                <strong>${match.team2_name || 'TBA'}</strong>
                                <span>${match.team2_score || ''}</span>
                            </div>
                            <div style="font-size:12px;color:#666;margin-top:5px;">
                                ${match.series_name || ''} ${match.match_format ? '| ' + match.match_format : ''}
                                ${match.start_time ? '<br>' + new Date(match.start_time).toLocaleString() : ''}
                            </div>
                        </div>
                        <span class="status ${type}">${type === 'live' ? 'LIVE' : (type === 'upcoming' ? 'UPCOMING' : 'RESULT')}</span>
                    </div>
                `).join('');
                
                document.querySelectorAll('#autoMatchesContainer .match-item').forEach(item => {
                    item.addEventListener('click', function() {
                        document.querySelectorAll('#autoMatchesContainer .match-item').forEach(i => i.classList.remove('selected'));
                        this.classList.add('selected');
                        
                        autoSelectedMatch = JSON.parse(this.dataset.match);
                        generateAutoPostData(autoSelectedMatch);
                    });
                });
            } else {
                container.innerHTML = '<div class="no-matches">No matches found</div>';
            }
        })
        .catch(err => {
            container.innerHTML = '<div class="no-matches">Error loading matches</div>';
        });
}

function generateAutoPostData(match) {
    const team1 = match.team1_name || 'Team1';
    const team2 = match.team2_name || 'Team2';
    const format = match.match_format || 'Match';
    const series = match.series_name || '';
    const venue = match.venue || '';
    
    const team1Short = team1.substring(0, 3).toUpperCase();
    const team2Short = team2.substring(0, 3).toUpperCase();
    
    const title = `${team1} vs ${team2} Today Live Match - ${format}${series ? ' | ' + series : ''}`;
    const metaTitle = `${team1} vs ${team2} Live Score | ${format} Today Match`;
    const slug = `${team1.toLowerCase().replace(/\s+/g, '-')}-vs-${team2.toLowerCase().replace(/\s+/g, '-')}-${format.toLowerCase().replace(/\s+/g, '-')}-live-score`;
    
    const keywordsList = [
        `${team1} vs ${team2} live score`,
        `${team1Short} vs ${team2Short} dream11 team`,
        `${team1} vs ${team2} prediction`,
        `${team1Short} vs ${team2Short} playing 11`,
        `${format} live score today`,
        `${team1} vs ${team2} pitch report`,
        `today match prediction`
    ];
    
    document.getElementById('previewTitle').textContent = title;
    document.getElementById('previewMetaTitle').textContent = metaTitle;
    document.getElementById('previewSlug').textContent = slug;
    document.getElementById('previewKeywords').textContent = keywordsList.slice(0, 5).join(', ');
    
    document.getElementById('autoGeneratedPreview').style.display = 'block';
    document.getElementById('createAutoPostBtn').disabled = false;
    
    document.getElementById('autoSelectedMatchInfo').innerHTML = `
        <strong>Selected:</strong> ${team1} vs ${team2}<br>
        <small>Match ID: ${match.match_id} | ${series}</small>
    `;
    document.getElementById('autoSelectedMatchInfo').classList.add('show');
    
    autoSelectedMatch.generatedData = {
        title: title,
        metaTitle: metaTitle,
        slug: slug,
        keywords: keywordsList.join(', ')
    };
}

document.querySelectorAll('.match-type-btn-auto').forEach(btn => {
    btn.addEventListener('click', function() {
        document.querySelectorAll('.match-type-btn-auto').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        const dateFilter = document.getElementById('autoMatchDate').value;
        loadAutoMatches(this.dataset.type, dateFilter || null);
    });
});

document.getElementById('autoMatchDate').addEventListener('change', function() {
    const activeType = document.querySelector('.match-type-btn-auto.active');
    const type = activeType ? activeType.dataset.type : 'upcoming';
    loadAutoMatches(type, this.value || null);
});

document.getElementById('createAutoPostBtn').addEventListener('click', async function() {
    if (!autoSelectedMatch || !autoSelectedMatch.generatedData) {
        alert('Please select a match first');
        return;
    }
    
    this.disabled = true;
    this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating Post...';
    
    const match = autoSelectedMatch;
    const data = match.generatedData;
    const team1 = match.team1_name || 'Team1';
    const team2 = match.team2_name || 'Team2';
    const format = match.match_format || 'Match';
    
    const content = `
        <h2>${team1} vs ${team2} Live Score</h2>
        <p>Get the latest live score updates for ${team1} vs ${team2} ${format} match. Follow ball-by-ball commentary, live scorecard, and real-time updates.</p>
        
        <h3>Match Details</h3>
        <p><strong>Match:</strong> ${team1} vs ${team2}</p>
        <p><strong>Format:</strong> ${format}</p>
        <p><strong>Series:</strong> ${match.series_name || 'N/A'}</p>
        
        <h3>Dream11 Team Prediction</h3>
        <p>Check out our expert Dream11 team prediction for today's ${team1} vs ${team2} match. Build your winning fantasy team!</p>
        
        <h3>Live Scorecard</h3>
        <p>The live scorecard will appear below once the match starts. Refresh for latest updates.</p>
    `;
    
    const formData = {
        title: data.title,
        slug: data.slug,
        content: content,
        excerpt: `Get ${team1} vs ${team2} live score, dream11 team prediction, pitch report and playing 11 for today's ${format} match.`,
        match_id: match.match_id,
        is_published: document.getElementById('autoPublish').checked,
        is_featured: document.getElementById('autoFeatured').checked,
        meta_title: data.metaTitle,
        meta_description: `${team1} vs ${team2} live score - Get ball by ball updates, dream11 team prediction, pitch report, playing 11 and match preview for ${format}.`,
        meta_keywords: data.keywords,
        og_title: data.title,
        og_description: `Get ${team1} vs ${team2} live score, dream11 prediction and match updates.`,
        author: 'Admin'
    };
    
    try {
        const res = await fetch('/api/posts', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(formData)
        });
        const result = await res.json();
        if (result.success) {
            alert('Auto Post created successfully!');
            window.location.href = '/admin/posts';
        } else {
            alert(result.message || 'Error creating post');
            this.disabled = false;
            this.innerHTML = '<i class="fas fa-bolt"></i> Create Auto Post';
        }
    } catch (err) {
        alert('Error: ' + err.message);
        this.disabled = false;
        this.innerHTML = '<i class="fas fa-bolt"></i> Create Auto Post';
    }
});

const tomorrow = new Date();
tomorrow.setDate(tomorrow.getDate() + 1);
document.getElementById('autoMatchDate').valueAsDate = tomorrow;
</script>
{% endblock %}
