{% extends 'admin/base.html' %}

{% block title %}Matches - Admin Panel{% endblock %}
{% block page_title %}Matches{% endblock %}

{% block content %}
<div class="admin-page">
    <div class="page-header">
        <h2>Manage Matches</h2>
        <div class="header-buttons">
            <button class="btn btn-primary" id="scrapeLiveBtn" onclick="scrapeLiveScores()">Scrape Live Scores</button>
            <button class="btn btn-danger" id="clearMatchesBtn" onclick="clearAllMatches()">Clear All</button>
        </div>
    </div>
    
    <div class="scrape-card" style="margin-bottom: 20px; padding: 15px; background: #1e1e1e; border-radius: 8px;">
        <h3 style="color: #00deaa; margin-bottom: 15px;">Live Scores Scraper</h3>
        <p style="color: #888; margin-bottom: 10px;">Scrape all current matches from Cricbuzz (Live, Innings Break, Complete, Upcoming)</p>
        <div style="background: #2a2a2a; padding: 10px 15px; border-radius: 5px; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
            <span style="color: #888; font-size: 0.85rem;">Source URL:</span>
            <a href="https://www.cricbuzz.com/cricket-match/live-scores" target="_blank" style="color: #00deaa; font-size: 0.9rem; word-break: break-all;">https://www.cricbuzz.com/cricket-match/live-scores</a>
        </div>
        <div id="liveScrapingResult" style="display: none; padding: 10px; border-radius: 5px; margin-top: 10px;"></div>
    </div>
    
    <div class="filter-tabs" style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
        <button class="filter-tab active" data-filter="all" onclick="filterMatches('all')">
            All <span class="tab-count">{{ matches|length }}</span>
        </button>
        <button class="filter-tab" data-filter="Live" onclick="filterMatches('Live')" style="border-color: #ff4444;">
            Live <span class="tab-count" style="background: #ff4444;">{{ live_count }}</span>
        </button>
        <button class="filter-tab" data-filter="Innings Break" onclick="filterMatches('Innings Break')" style="border-color: #ffaa00;">
            Innings Break <span class="tab-count" style="background: #ffaa00; color: #333;">{{ innings_count }}</span>
        </button>
        <button class="filter-tab" data-filter="Complete" onclick="filterMatches('Complete')" style="border-color: #00cc66;">
            Complete <span class="tab-count" style="background: #00cc66;">{{ complete_count }}</span>
        </button>
        <button class="filter-tab" data-filter="Upcoming" onclick="filterMatches('Upcoming')" style="border-color: #3498db;">
            Upcoming <span class="tab-count" style="background: #3498db;">{{ upcoming_count }}</span>
        </button>
        <button class="filter-tab" data-filter="has-result" onclick="filterMatches('has-result')" style="border-color: #9b59b6;">
            With Result <span class="tab-count" style="background: #9b59b6;">{{ result_count }}</span>
        </button>
    </div>
    
    {% if matches %}
    <div class="matches-table-container">
        <table class="matches-table">
            <thead>
                <tr>
                    <th>Match ID</th>
                    <th>Status</th>
                    <th>Date</th>
                    <th>Match</th>
                    <th>Teams</th>
                    <th>Score</th>
                    <th>Venue</th>
                    <th>Result</th>
                </tr>
            </thead>
            <tbody>
                {% for match in matches %}
                <tr data-state="{{ match.state or 'Unknown' }}" data-has-result="{{ 'yes' if match.result else 'no' }}">
                    <td class="id-col">{{ match.match_id or '-' }}</td>
                    <td class="status-col">
                        <span class="status-badge {% if match.state == 'Live' %}live{% elif match.state == 'Innings Break' %}innings{% elif match.state == 'Complete' %}complete{% else %}upcoming{% endif %}">
                            {{ match.state or 'Unknown' }}
                        </span>
                    </td>
                    <td class="date-col">{{ match.match_date or 'TBD' }}</td>
                    <td class="format-col">{{ match.match_format or '-' }}</td>
                    <td class="teams-col">
                        <strong>{{ match.team1_name or 'Team 1' }}</strong> vs <strong>{{ match.team2_name or 'Team 2' }}</strong>
                    </td>
                    <td class="score-col">
                        <span>{{ match.team1_score or '-' }}</span> / <span>{{ match.team2_score or '-' }}</span>
                    </td>
                    <td class="venue-col">{{ match.venue[:30] + '...' if match.venue and match.venue|length > 30 else (match.venue or '-') }}</td>
                    <td class="result-col {% if match.result %}has-result{% endif %}">{{ match.result or 'TBD' }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="no-data">
        <p>No matches scraped yet</p>
        <p class="hint">Go to Series page and scrape matches from a series</p>
    </div>
    {% endif %}
</div>

<style>
.page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}

.page-header h2 {
    font-size: 16px;
    margin: 0;
    color: #333;
}

.header-buttons {
    display: flex;
    gap: 8px;
}

.btn {
    padding: 5px 12px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 11px;
    font-weight: 500;
}

.btn-danger {
    background: #dc3545;
    color: white;
}

.btn-danger:hover {
    background: #c82333;
}

.filter-tabs {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
    flex-wrap: wrap;
}

.filter-tab {
    background: #2a2a2a;
    border: 2px solid #444;
    color: #ccc;
    padding: 8px 16px;
    border-radius: 20px;
    cursor: pointer;
    font-size: 0.85rem;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: all 0.2s;
}

.filter-tab:hover {
    background: #333;
}

.filter-tab.active {
    background: #00deaa;
    border-color: #00deaa;
    color: #111;
}

.tab-count {
    background: #444;
    color: #fff;
    padding: 2px 8px;
    border-radius: 10px;
    font-size: 0.75rem;
    font-weight: bold;
}

.filter-tab.active .tab-count {
    background: rgba(0,0,0,0.2);
    color: #111;
}

.status-badge {
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 0.7rem;
    font-weight: 600;
    text-transform: uppercase;
}

.status-badge.live {
    background: #ff4444;
    color: white;
}

.status-badge.innings {
    background: #ffaa00;
    color: #333;
}

.status-badge.complete {
    background: #00cc66;
    color: white;
}

.status-badge.upcoming {
    background: #3498db;
    color: white;
}

.stats-row {
    display: flex;
    gap: 12px;
    margin-bottom: 15px;
}

.stat-box {
    background: #1f2937;
    padding: 10px 15px;
    border-radius: 6px;
    border: 1px solid #374151;
    display: flex;
    align-items: center;
    gap: 10px;
}

.stat-num {
    font-size: 20px;
    font-weight: 700;
    color: #10b981;
}

.stat-label {
    font-size: 11px;
    color: #9ca3af;
}

.matches-table-container {
    background: #1f2937;
    border-radius: 6px;
    border: 1px solid #374151;
    overflow: hidden;
}

.matches-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 11px;
}

.matches-table th {
    background: #111827;
    color: #e4e4e7;
    padding: 8px 10px;
    text-align: left;
    font-weight: 600;
    font-size: 10px;
    text-transform: uppercase;
}

.matches-table td {
    padding: 8px 10px;
    border-bottom: 1px solid #374151;
    vertical-align: middle;
    color: #e4e4e7;
}

.matches-table tbody tr:hover {
    background: #374151;
}

.date-col {
    color: #e4e4e7;
    font-weight: 600;
    white-space: nowrap;
}

.format-col {
    color: #9ca3af;
    font-size: 10px;
}

.teams-col strong {
    color: #e4e4e7;
}

.score-col {
    font-family: monospace;
    font-size: 10px;
    color: #e4e4e7;
}

.venue-col {
    color: #9ca3af;
    font-size: 10px;
    max-width: 150px;
}

.result-col {
    color: #9ca3af;
    font-size: 10px;
}

.result-col.has-result {
    color: #10b981;
    font-weight: 600;
}

.no-data {
    text-align: center;
    padding: 40px;
    background: #1f2937;
    border-radius: 8px;
    color: #9ca3af;
}

.no-data .hint {
    font-size: 12px;
    color: #6b7280;
    margin-top: 10px;
}
</style>

<script>
function scrapeLiveScores() {
    const btn = document.getElementById('scrapeLiveBtn');
    const resultDiv = document.getElementById('liveScrapingResult');
    
    btn.disabled = true;
    btn.textContent = 'Scraping...';
    resultDiv.style.display = 'block';
    resultDiv.style.background = '#333';
    resultDiv.innerHTML = '<span style="color: #00deaa;">Scraping live scores from Cricbuzz...</span>';
    
    fetch('/api/scrape/live-scores', { method: 'POST' })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                resultDiv.style.background = '#1a4d1a';
                resultDiv.innerHTML = `
                    <div style="color: #00ff00; font-weight: bold;">Scraping Complete!</div>
                    <div style="color: #ccc; margin-top: 8px;">
                        <span style="margin-right: 15px;">Total: ${data.counts.total}</span>
                        <span style="margin-right: 15px; color: #ff4444;">Live: ${data.counts.live}</span>
                        <span style="margin-right: 15px; color: #ffaa00;">Innings Break: ${data.counts.innings_break}</span>
                        <span style="color: #00cc66;">Complete: ${data.counts.complete}</span>
                    </div>
                    <div style="color: #888; margin-top: 5px;">Saved: ${data.saved} new, Updated: ${data.updated} existing</div>
                `;
                setTimeout(() => location.reload(), 2000);
            } else {
                resultDiv.style.background = '#4d1a1a';
                resultDiv.innerHTML = `<span style="color: #ff4444;">Error: ${data.message}</span>`;
            }
            btn.disabled = false;
            btn.textContent = 'Scrape Live Scores';
        })
        .catch(e => {
            resultDiv.style.background = '#4d1a1a';
            resultDiv.innerHTML = `<span style="color: #ff4444;">Error: ${e}</span>`;
            btn.disabled = false;
            btn.textContent = 'Scrape Live Scores';
        });
}

function clearAllMatches() {
    if (confirm('Are you sure you want to delete all matches?')) {
        const btn = document.getElementById('clearMatchesBtn');
        btn.disabled = true;
        btn.textContent = 'Clearing...';
        
        fetch('/api/matches/clear', { method: 'POST' })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);
                    location.reload();
                } else {
                    alert('Error: ' + data.message);
                    btn.disabled = false;
                    btn.textContent = 'Clear All';
                }
            })
            .catch(e => {
                alert('Error: ' + e);
                btn.disabled = false;
                btn.textContent = 'Clear All';
            });
    }
}

function filterMatches(status) {
    const tabs = document.querySelectorAll('.filter-tab');
    tabs.forEach(tab => {
        tab.classList.remove('active');
        if (tab.dataset.filter === status) {
            tab.classList.add('active');
        }
    });
    
    const rows = document.querySelectorAll('.matches-table tbody tr');
    rows.forEach(row => {
        if (status === 'all') {
            row.style.display = '';
        } else if (status === 'has-result') {
            row.style.display = row.dataset.hasResult === 'yes' ? '' : 'none';
        } else {
            row.style.display = row.dataset.state === status ? '' : 'none';
        }
    });
}
</script>
{% endblock %}
