{% extends 'admin/base.html' %}

{% block title %}Matches - Admin Panel{% endblock %}
{% block page_title %}Matches{% endblock %}

{% block content %}
<div class="admin-page">
    <div class="page-header">
        <h2>Manage Matches</h2>
        <span class="today-badge">Today: {{ today_date }}</span>
        <div class="header-buttons">
            <button class="btn btn-primary" id="scrapeLiveBtn" onclick="scrapeLiveScores()">Scrape Live Scores</button>
            <button class="btn btn-danger" id="clearMatchesBtn" onclick="clearAllMatches()">Clear All</button>
        </div>
    </div>
    
    <div class="scrape-card" style="margin-bottom: 20px; padding: 15px; background: #1e1e1e; border-radius: 8px;">
        <h3 style="color: #00deaa; margin-bottom: 15px;">Live Scores Scraper</h3>
        <p style="color: #888; margin-bottom: 10px;">Scrape all current matches from Cricbuzz (Live, Innings Break, Complete, Upcoming)</p>
        <div style="background: #2a2a2a; padding: 10px 15px; border-radius: 5px; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
            <span style="color: #888; font-size: 0.85rem;">Recent Matches:</span>
            <a href="https://www.cricbuzz.com/cricket-match/live-scores/recent-matches" target="_blank" style="color: #00deaa; font-size: 0.9rem; word-break: break-all;">https://www.cricbuzz.com/cricket-match/live-scores/recent-matches</a>
        </div>
        <div id="liveScrapingResult" style="display: none; padding: 10px; border-radius: 5px; margin-top: 10px;"></div>
    </div>
    
    <div class="filter-tabs" style="display: flex; gap: 4px; margin-bottom: 15px; flex-wrap: nowrap; overflow-x: auto;">
        <button class="filter-tab active" data-filter="all" onclick="filterMatches('all')">All<span class="tab-count">{{ matches|length }}</span></button>
        <button class="filter-tab" data-filter="Live" onclick="filterMatches('Live')" style="border-color: #ff4444;">Live<span class="tab-count" style="background: #ff4444;">{{ live_count }}</span></button>
        <button class="filter-tab" data-filter="In Progress" onclick="filterMatches('In Progress')" style="border-color: #e74c3c;">Progress<span class="tab-count" style="background: #e74c3c;">{{ in_progress_count }}</span></button>
        <button class="filter-tab" data-filter="Innings Break" onclick="filterMatches('Innings Break')" style="border-color: #ffaa00;">Break<span class="tab-count" style="background: #ffaa00; color: #333;">{{ innings_count }}</span></button>
        <button class="filter-tab" data-filter="Stumps" onclick="filterMatches('Stumps')" style="border-color: #8e44ad;">Stumps<span class="tab-count" style="background: #8e44ad;">{{ stumps_count }}</span></button>
        <button class="filter-tab" data-filter="Lunch" onclick="filterMatches('Lunch')" style="border-color: #f39c12;">Lunch<span class="tab-count" style="background: #f39c12; color: #333;">{{ lunch_count }}</span></button>
        <button class="filter-tab" data-filter="Tea" onclick="filterMatches('Tea')" style="border-color: #d35400;">Tea<span class="tab-count" style="background: #d35400;">{{ tea_count }}</span></button>
        <button class="filter-tab" data-filter="Drinks" onclick="filterMatches('Drinks')" style="border-color: #1abc9c;">Drinks<span class="tab-count" style="background: #1abc9c;">{{ drinks_count }}</span></button>
        <button class="filter-tab" data-filter="Complete" onclick="filterMatches('Complete')" style="border-color: #00cc66;">Done<span class="tab-count" style="background: #00cc66;">{{ complete_count }}</span></button>
        <button class="filter-tab" data-filter="Preview" onclick="filterMatches('Preview')" style="border-color: #9b59b6;">Preview<span class="tab-count" style="background: #9b59b6;">{{ preview_count }}</span></button>
        <button class="filter-tab" data-filter="Upcoming" onclick="filterMatches('Upcoming')" style="border-color: #3498db;">Soon<span class="tab-count" style="background: #3498db;">{{ upcoming_count }}</span></button>
        <button class="filter-tab" data-filter="Abandon" onclick="filterMatches('Abandon')" style="border-color: #7f8c8d;">Abandon<span class="tab-count" style="background: #7f8c8d;">{{ abandon_count }}</span></button>
        <button class="filter-tab" data-filter="has-result" onclick="filterMatches('has-result')" style="border-color: #2ecc71;">Result<span class="tab-count" style="background: #2ecc71;">{{ result_count }}</span></button>
        <button class="filter-tab" data-filter="has-status" onclick="filterMatches('has-status')" style="border-color: #e67e22;">Status<span class="tab-count" style="background: #e67e22;">{{ status_count }}</span></button>
    </div>
    
    <div class="tables-container">
        <div class="table-section">
            <div class="table-header series" style="background: linear-gradient(135deg, #8b5cf6, #6366f1);">
                <span>ðŸ“‹ Matches (<span id="match-count">{{ matches|length if matches else 0 }}</span>)</span>
                <div style="display: flex; gap: 10px; margin-left: 15px;">
                    <button type="button" class="btn btn-sm" onclick="scrapeLiveScores()" id="scrape-btn" style="background: rgba(255,255,255,0.2); color: #fff; border: none; padding: 5px 15px; border-radius: 5px; cursor: pointer;">Fetch Data</button>
                    <button type="button" class="btn btn-sm" onclick="sortMatchesByStatus()" style="background: #ef4444; color: #fff; border: none; padding: 5px 15px; border-radius: 5px; cursor: pointer;">ðŸ”´ Live First</button>
                </div>
            </div>
            <div class="table-wrapper">
                <table class="excel-table">
                    <thead>
                        <tr>
                            <th>Series</th>
                            <th>Match</th>
                            <th>Team 1</th>
                            <th>Score</th>
                            <th>Team 2</th>
                            <th>Score</th>
                            <th>Status</th>
                            <th>Result</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="matches-tbody">
                        {% if matches %}
                            {% for m in matches %}
                            <tr id="row-{{ m.match_id }}" data-state="{{ m.state or 'Unknown' }}" data-has-result="{{ 'yes' if m.result else 'no' }}" data-has-status="{{ 'yes' if (m.result and ('opt to' in m.result.lower() if m.result else False)) else 'no' }}">
                                <td><a href="https://www.cricbuzz.com/cricket-series/{{ m.cricbuzz_series_id }}" target="_blank" title="{{ m.match_format }}">{{ m.match_format[:20] if m.match_format else '-' }}...</a></td>
                                <td><a href="https://www.cricbuzz.com/live-cricket-scores/{{ m.match_id }}" target="_blank">{{ m.match_id }}</a></td>
                                <td class="team-cell">{% if m.team1_flag %}<img src="{{ m.team1_flag }}" class="team-flag" alt="">{% endif %} {{ m.team1_name or 'Team 1' }}</td>
                                <td class="score-cell">{{ m.team1_score or '-' }}</td>
                                <td class="team-cell">{% if m.team2_flag %}<img src="{{ m.team2_flag }}" class="team-flag" alt="">{% endif %} {{ m.team2_name or 'Team 2' }}</td>
                                <td class="score-cell">{{ m.team2_score or '-' }}</td>
                                <td class="status-cell {% if m.state == 'Live' %}status-live{% elif m.state == 'Complete' %}status-completed{% endif %}">{{ m.state or '-' }}</td>
                                <td class="result-cell">{{ m.result or '-' }}</td>
                                <td><button class="scrape-btn" onclick="scrapeScorecard('{{ m.match_id }}', '{{ m.cricbuzz_series_id }}', this)">Scrape</button></td>
                            </tr>
                            {% endfor %}
                        {% else %}
                            <tr><td colspan="9" class="no-data">No matches available. Click "Fetch Data" to load.</td></tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<style>
.page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}

.page-header h2 {
    font-size: 16px;
    margin: 0;
    color: #333;
}

.today-badge {
    background: #00deaa;
    color: #111;
    padding: 6px 14px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
}

.header-buttons {
    display: flex;
    gap: 8px;
}

.btn {
    padding: 5px 12px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 11px;
    font-weight: 500;
}

.btn-danger {
    background: #dc3545;
    color: white;
}

.btn-danger:hover {
    background: #c82333;
}

.filter-tabs {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
    flex-wrap: wrap;
}

.filter-tab {
    background: #2a2a2a;
    border: 1px solid #444;
    color: #ccc;
    padding: 4px 8px;
    border-radius: 12px;
    cursor: pointer;
    font-size: 0.7rem;
    display: flex;
    align-items: center;
    gap: 3px;
    transition: all 0.2s;
    white-space: nowrap;
}

.filter-tab:hover {
    background: #333;
}

.filter-tab.active {
    background: #00deaa;
    border-color: #00deaa;
    color: #111;
}

.tab-count {
    background: #444;
    color: #fff;
    padding: 1px 5px;
    border-radius: 8px;
    font-size: 0.65rem;
    font-weight: bold;
}

.filter-tab.active .tab-count {
    background: rgba(0,0,0,0.2);
    color: #111;
}

.status-badge {
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 0.7rem;
    font-weight: 600;
    text-transform: uppercase;
}

.status-badge.live {
    background: #ff4444;
    color: white;
}

.status-badge.innings {
    background: #ffaa00;
    color: #333;
}

.status-badge.complete {
    background: #00cc66;
    color: white;
}

.status-badge.upcoming {
    background: #3498db;
    color: white;
}

.status-badge.inprogress {
    background: #e74c3c;
    color: white;
}

.status-badge.stumps {
    background: #8e44ad;
    color: white;
}

.status-badge.lunch {
    background: #f39c12;
    color: #333;
}

.status-badge.tea {
    background: #d35400;
    color: white;
}

.status-badge.drinks {
    background: #1abc9c;
    color: white;
}

.status-badge.preview {
    background: #9b59b6;
    color: white;
}

.status-badge.abandon {
    background: #7f8c8d;
    color: white;
}

.stats-row {
    display: flex;
    gap: 12px;
    margin-bottom: 15px;
}

.stat-box {
    background: #1f2937;
    padding: 10px 15px;
    border-radius: 6px;
    border: 1px solid #374151;
    display: flex;
    align-items: center;
    gap: 10px;
}

.stat-num {
    font-size: 20px;
    font-weight: 700;
    color: #10b981;
}

.stat-label {
    font-size: 11px;
    color: #9ca3af;
}

.tables-container {
    display: flex;
    flex-direction: column;
    gap: 20px;
}

.table-section {
    background: #1f2937;
    border-radius: 8px;
    overflow: hidden;
    border: 1px solid #374151;
}

.table-header {
    padding: 12px 15px;
    font-weight: 600;
    font-size: 0.95rem;
    color: #fff;
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.table-wrapper {
    overflow-x: auto;
}

.excel-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.8rem;
}

.excel-table th {
    background: #111827;
    padding: 10px 8px;
    text-align: left;
    font-weight: 600;
    border: 1px solid #374151;
    white-space: nowrap;
    color: #e4e4e7;
}

.excel-table td {
    padding: 8px;
    border: 1px solid #374151;
    vertical-align: middle;
    color: #e4e4e7;
    background: #1f2937;
}

.excel-table tbody tr:nth-child(even) td {
    background: #111827;
}

.excel-table tbody tr:hover td {
    background: #374151;
}

.excel-table td a {
    color: #3b82f6;
    text-decoration: none;
    font-weight: 600;
}

.excel-table td a:hover {
    text-decoration: underline;
}

.team-cell {
    white-space: nowrap;
}

.team-flag {
    width: 20px;
    height: 14px;
    object-fit: cover;
    border-radius: 2px;
    vertical-align: middle;
    margin-right: 5px;
}

.score-cell {
    font-weight: 600;
    color: #10b981;
}

.status-cell {
    white-space: nowrap;
}

.status-cell.status-live {
    color: #ef4444;
    font-weight: 700;
}

.status-cell.status-completed {
    color: #10b981;
}

.result-cell {
    max-width: 200px;
    font-size: 0.75rem;
    color: #9ca3af;
}

.scrape-btn {
    background: #3b82f6;
    color: #fff;
    border: none;
    padding: 4px 10px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.7rem;
}

.scrape-btn:hover {
    background: #2563eb;
}

.date-col {
    color: #e4e4e7;
    font-weight: 600;
    white-space: nowrap;
}

.format-col {
    color: #9ca3af;
    font-size: 10px;
}

.teams-col strong {
    color: #e4e4e7;
}

.score-col {
    font-family: monospace;
    font-size: 10px;
    color: #e4e4e7;
}

.venue-col {
    color: #9ca3af;
    font-size: 10px;
    max-width: 150px;
}

.result-col {
    color: #9ca3af;
    font-size: 10px;
}

.result-col.has-result {
    color: #10b981;
    font-weight: 600;
}

.no-data {
    text-align: center;
    padding: 40px;
    background: #1f2937;
    border-radius: 8px;
    color: #9ca3af;
}

.no-data .hint {
    font-size: 12px;
    color: #6b7280;
    margin-top: 10px;
}
</style>

<script>
function scrapeLiveScores() {
    const btn = document.getElementById('scrape-btn');
    const resultDiv = document.getElementById('liveScrapingResult');
    const tbody = document.getElementById('matches-tbody');
    
    if (btn) {
        btn.disabled = true;
        btn.textContent = 'Fetching...';
    }
    resultDiv.style.display = 'block';
    resultDiv.style.background = '#333';
    resultDiv.innerHTML = '<span style="color: #00deaa;">Fetching recent matches from Cricbuzz...</span>';
    
    fetch('/api/matches/scrape-recent', { method: 'POST' })
        .then(r => r.json())
        .then(data => {
            if (data.success && data.matches) {
                resultDiv.style.background = '#1a4d1a';
                resultDiv.innerHTML = `
                    <div style="color: #00ff00; font-weight: bold;">Fetch Complete!</div>
                    <div style="color: #ccc; margin-top: 8px;">Found ${data.count} recent matches</div>
                `;
                
                document.getElementById('match-count').textContent = data.count;
                
                if (data.matches.length > 0) {
                    let html = '';
                    data.matches.forEach(m => {
                        html += `
                        <tr id="row-${m.match_id}" data-state="${m.state || 'Complete'}" data-has-result="${m.result ? 'yes' : 'no'}">
                            <td><a href="https://www.cricbuzz.com/cricket-series/${m.series_id}" target="_blank" title="${m.series_name}">${(m.series_name || '-').substring(0, 20)}...</a></td>
                            <td><a href="https://www.cricbuzz.com/live-cricket-scores/${m.match_id}" target="_blank">${m.match_id}</a></td>
                            <td class="team-cell">${m.team1_flag ? `<img src="${m.team1_flag}" class="team-flag" alt="">` : ''} ${m.team1_name || 'Team 1'}</td>
                            <td class="score-cell">-</td>
                            <td class="team-cell">${m.team2_flag ? `<img src="${m.team2_flag}" class="team-flag" alt="">` : ''} ${m.team2_name || 'Team 2'}</td>
                            <td class="score-cell">-</td>
                            <td class="status-cell status-completed">${m.state || 'Complete'}</td>
                            <td class="result-cell">${m.result || '-'}</td>
                            <td><button class="scrape-btn" onclick="scrapeScorecard('${m.match_id}', '${m.series_id}', this)">Scrape</button></td>
                        </tr>`;
                    });
                    tbody.innerHTML = html;
                }
            } else {
                resultDiv.style.background = '#4d1a1a';
                resultDiv.innerHTML = `<span style="color: #ff4444;">Error: ${data.message}</span>`;
            }
            if (btn) {
                btn.disabled = false;
                btn.textContent = 'Fetch Data';
            }
        })
        .catch(e => {
            resultDiv.style.background = '#4d1a1a';
            resultDiv.innerHTML = `<span style="color: #ff4444;">Error: ${e}</span>`;
            if (btn) {
                btn.disabled = false;
                btn.textContent = 'Fetch Data';
            }
        });
}

function scrapeScorecard(matchId, seriesId, btn) {
    btn.disabled = true;
    btn.textContent = 'Scraping...';
    
    fetch(`/api/scrape/scorecard/${matchId}?series_id=${seriesId}`, { method: 'POST' })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                btn.textContent = 'Done!';
                btn.style.background = '#10b981';
            } else {
                btn.textContent = 'Error';
                btn.style.background = '#ef4444';
            }
        })
        .catch(e => {
            btn.textContent = 'Error';
            btn.style.background = '#ef4444';
        });
}

function sortMatchesByStatus() {
    const tbody = document.getElementById('matches-tbody');
    const rows = Array.from(tbody.querySelectorAll('tr'));
    
    rows.sort((a, b) => {
        const stateOrder = {'Live': 0, 'In Progress': 1, 'Innings Break': 2, 'Complete': 3, 'Upcoming': 4};
        const stateA = stateOrder[a.dataset.state] || 5;
        const stateB = stateOrder[b.dataset.state] || 5;
        return stateA - stateB;
    });
    
    rows.forEach(row => tbody.appendChild(row));
}

function clearAllMatches() {
    if (confirm('Are you sure you want to delete all matches?')) {
        const btn = document.getElementById('clearMatchesBtn');
        btn.disabled = true;
        btn.textContent = 'Clearing...';
        
        fetch('/api/matches/clear', { method: 'POST' })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);
                    location.reload();
                } else {
                    alert('Error: ' + data.message);
                    btn.disabled = false;
                    btn.textContent = 'Clear All';
                }
            })
            .catch(e => {
                alert('Error: ' + e);
                btn.disabled = false;
                btn.textContent = 'Clear All';
            });
    }
}

function filterMatches(status) {
    const tabs = document.querySelectorAll('.filter-tab');
    tabs.forEach(tab => {
        tab.classList.remove('active');
        if (tab.dataset.filter === status) {
            tab.classList.add('active');
        }
    });
    
    const rows = document.querySelectorAll('#matches-tbody tr');
    rows.forEach(row => {
        if (status === 'all') {
            row.style.display = '';
        } else if (status === 'has-result') {
            row.style.display = row.dataset.hasResult === 'yes' ? '' : 'none';
        } else if (status === 'has-status') {
            row.style.display = row.dataset.hasStatus === 'yes' ? '' : 'none';
        } else {
            row.style.display = row.dataset.state === status ? '' : 'none';
        }
    });
}
</script>
{% endblock %}
