{% extends "admin/base.html" %}

{% block title %}Categories - Admin{% endblock %}
{% block page_title %}Post Categories{% endblock %}

{% block content %}
<div class="admin-section">
    <div class="section-header">
        <h2>Manage Categories</h2>
        <button class="btn btn-primary" onclick="showAddModal()">+ Add Category</button>
    </div>
    
    <div class="table-container">
        <table class="admin-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Name</th>
                    <th>Slug</th>
                    <th>Show in Navbar</th>
                    <th>Order</th>
                    <th>Posts</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for cat in categories %}
                <tr>
                    <td>{{ cat.id }}</td>
                    <td>{{ cat.name }}</td>
                    <td>{{ cat.slug }}</td>
                    <td>{{ 'Yes' if cat.show_in_navbar else 'No' }}</td>
                    <td>{{ cat.navbar_order }}</td>
                    <td>{{ cat.posts|length }}</td>
                    <td>
                        <button class="btn btn-sm btn-edit" onclick="editCategory({{ cat.id }}, '{{ cat.name }}', '{{ cat.slug }}', '{{ cat.description or '' }}', {{ 'true' if cat.show_in_navbar else 'false' }}, {{ cat.navbar_order }})">Edit</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteCategory({{ cat.id }})">Delete</button>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="7" style="text-align: center;">No categories found. Add your first category!</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<div id="categoryModal" class="modal" style="display: none;">
    <div class="modal-content">
        <span class="modal-close" onclick="closeModal()">&times;</span>
        <h3 id="modalTitle">Add Category</h3>
        <form id="categoryForm">
            <input type="hidden" id="categoryId" name="id">
            <div class="form-group">
                <label for="categoryName">Name *</label>
                <input type="text" id="categoryName" name="name" required placeholder="Category name">
            </div>
            <div class="form-group">
                <label for="categorySlug">Slug *</label>
                <input type="text" id="categorySlug" name="slug" required placeholder="category-slug">
            </div>
            <div class="form-group">
                <label for="categoryDesc">Description</label>
                <textarea id="categoryDesc" name="description" rows="3" placeholder="Category description"></textarea>
            </div>
            <div class="form-group">
                <label>
                    <input type="checkbox" id="showInNavbar" name="show_in_navbar" checked>
                    Show in Navbar
                </label>
            </div>
            <div class="form-group">
                <label for="navbarOrder">Navbar Order</label>
                <input type="number" id="navbarOrder" name="navbar_order" value="0" min="0">
            </div>
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Save</button>
            </div>
        </form>
    </div>
</div>

<style>
.admin-section { padding: 20px; }
.section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
.section-header h2 { margin: 0; color: #333; }
.table-container { background: #fff; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); overflow-x: auto; }
.admin-table { width: 100%; border-collapse: collapse; }
.admin-table th, .admin-table td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #eee; }
.admin-table th { background: #f8f9fa; font-weight: 600; color: #333; }
.admin-table tr:hover { background: #f8f9fa; }
.btn { padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; }
.btn-primary { background: #1a472a; color: #fff; }
.btn-primary:hover { background: #0d2818; }
.btn-secondary { background: #6c757d; color: #fff; }
.btn-danger { background: #dc3545; color: #fff; }
.btn-edit { background: #007bff; color: #fff; }
.btn-sm { padding: 4px 8px; font-size: 12px; }
.modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; }
.modal-content { background: #fff; padding: 30px; border-radius: 8px; width: 100%; max-width: 500px; position: relative; }
.modal-close { position: absolute; top: 15px; right: 20px; font-size: 24px; cursor: pointer; color: #666; }
.form-group { margin-bottom: 15px; }
.form-group label { display: block; margin-bottom: 5px; font-weight: 500; color: #333; }
.form-group input[type="text"], .form-group input[type="number"], .form-group textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; }
.form-group input[type="checkbox"] { margin-right: 8px; }
.form-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; }
</style>

<script>
function showAddModal() {
    document.getElementById('modalTitle').textContent = 'Add Category';
    document.getElementById('categoryForm').reset();
    document.getElementById('categoryId').value = '';
    document.getElementById('showInNavbar').checked = true;
    document.getElementById('categoryModal').style.display = 'flex';
}

function editCategory(id, name, slug, desc, showNav, order) {
    document.getElementById('modalTitle').textContent = 'Edit Category';
    document.getElementById('categoryId').value = id;
    document.getElementById('categoryName').value = name;
    document.getElementById('categorySlug').value = slug;
    document.getElementById('categoryDesc').value = desc;
    document.getElementById('showInNavbar').checked = showNav;
    document.getElementById('navbarOrder').value = order;
    document.getElementById('categoryModal').style.display = 'flex';
}

function closeModal() {
    document.getElementById('categoryModal').style.display = 'none';
}

document.getElementById('categoryName').addEventListener('input', function() {
    if (!document.getElementById('categoryId').value) {
        const slug = this.value.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '');
        document.getElementById('categorySlug').value = slug;
    }
});

document.getElementById('categoryForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const id = document.getElementById('categoryId').value;
    const data = {
        name: document.getElementById('categoryName').value,
        slug: document.getElementById('categorySlug').value,
        description: document.getElementById('categoryDesc').value,
        show_in_navbar: document.getElementById('showInNavbar').checked,
        navbar_order: parseInt(document.getElementById('navbarOrder').value) || 0
    };
    
    const url = id ? `/api/categories/${id}` : '/api/categories';
    const method = id ? 'PUT' : 'POST';
    
    try {
        const res = await fetch(url, {
            method: method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        const result = await res.json();
        if (result.success) {
            location.reload();
        } else {
            alert(result.message || 'Error saving category');
        }
    } catch (err) {
        alert('Error: ' + err.message);
    }
});

async function deleteCategory(id) {
    if (!confirm('Are you sure you want to delete this category?')) return;
    try {
        const res = await fetch(`/api/categories/${id}`, { method: 'DELETE' });
        const result = await res.json();
        if (result.success) {
            location.reload();
        } else {
            alert(result.message || 'Error deleting category');
        }
    } catch (err) {
        alert('Error: ' + err.message);
    }
}
</script>
{% endblock %}
