{% extends "admin/base.html" %}

{% block title %}Posts - Admin{% endblock %}
{% block page_title %}Posts Management{% endblock %}

{% block content %}
<div class="admin-section">
    <div class="section-header">
        <h2>All Posts</h2>
        <a href="/admin/posts/new" class="btn btn-primary">+ New Post</a>
    </div>
    
    <div class="filters">
        <select id="categoryFilter" onchange="filterPosts()">
            <option value="">All Categories</option>
            {% for cat in categories %}
            <option value="{{ cat.id }}">{{ cat.name }}</option>
            {% endfor %}
        </select>
        <select id="statusFilter" onchange="filterPosts()">
            <option value="">All Status</option>
            <option value="published">Published</option>
            <option value="draft">Draft</option>
        </select>
    </div>
    
    <div class="table-container">
        <table class="admin-table">
            <thead>
                <tr>
                    <th>Thumbnail</th>
                    <th>Title</th>
                    <th>Category</th>
                    <th>Status</th>
                    <th>Views</th>
                    <th>Date</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for post in posts %}
                <tr data-category="{{ post.category_id or '' }}" data-status="{{ 'published' if post.is_published else 'draft' }}">
                    <td>
                        {% if post.thumbnail %}
                        <img src="{{ post.thumbnail }}" alt="" class="post-thumb">
                        {% else %}
                        <div class="no-thumb">No Image</div>
                        {% endif %}
                    </td>
                    <td>
                        <strong>{{ post.title }}</strong>
                        <div class="post-slug">/{{ post.slug }}</div>
                    </td>
                    <td>{{ post.category.name if post.category else 'Uncategorized' }}</td>
                    <td>
                        <span class="status-badge {{ 'published' if post.is_published else 'draft' }}">
                            {{ 'Published' if post.is_published else 'Draft' }}
                        </span>
                    </td>
                    <td>{{ post.views }}</td>
                    <td>{{ post.created_at.strftime('%Y-%m-%d') }}</td>
                    <td>
                        <a href="/admin/posts/{{ post.id }}" class="btn btn-sm btn-edit">Edit</a>
                        <a href="/post/{{ post.slug }}" target="_blank" class="btn btn-sm btn-view">View</a>
                        <button class="btn btn-sm btn-danger" onclick="deletePost({{ post.id }})">Delete</button>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="7" style="text-align: center;">No posts found. Create your first post!</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<style>
.admin-section { padding: 20px; }
.section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
.section-header h2 { margin: 0; color: #333; }
.filters { display: flex; gap: 10px; margin-bottom: 15px; }
.filters select { padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; }
.table-container { background: #fff; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); overflow-x: auto; }
.admin-table { width: 100%; border-collapse: collapse; }
.admin-table th, .admin-table td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #eee; }
.admin-table th { background: #f8f9fa; font-weight: 600; color: #333; }
.admin-table tr:hover { background: #f8f9fa; }
.post-thumb { width: 60px; height: 40px; object-fit: cover; border-radius: 4px; }
.no-thumb { width: 60px; height: 40px; background: #eee; display: flex; align-items: center; justify-content: center; font-size: 10px; color: #999; border-radius: 4px; }
.post-slug { font-size: 12px; color: #888; margin-top: 4px; }
.status-badge { padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 500; }
.status-badge.published { background: #d4edda; color: #155724; }
.status-badge.draft { background: #fff3cd; color: #856404; }
.btn { padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; text-decoration: none; display: inline-block; }
.btn-primary { background: #1a472a; color: #fff; }
.btn-edit { background: #007bff; color: #fff; }
.btn-view { background: #17a2b8; color: #fff; }
.btn-danger { background: #dc3545; color: #fff; }
.btn-sm { padding: 4px 8px; font-size: 12px; }
</style>

<script>
function filterPosts() {
    const category = document.getElementById('categoryFilter').value;
    const status = document.getElementById('statusFilter').value;
    const rows = document.querySelectorAll('tbody tr[data-category]');
    
    rows.forEach(row => {
        const rowCat = row.dataset.category;
        const rowStatus = row.dataset.status;
        let show = true;
        
        if (category && rowCat !== category) show = false;
        if (status && rowStatus !== status) show = false;
        
        row.style.display = show ? '' : 'none';
    });
}

async function deletePost(id) {
    if (!confirm('Are you sure you want to delete this post?')) return;
    try {
        const res = await fetch(`/api/posts/${id}`, { method: 'DELETE' });
        const result = await res.json();
        if (result.success) {
            location.reload();
        } else {
            alert(result.message || 'Error deleting post');
        }
    } catch (err) {
        alert('Error: ' + err.message);
    }
}
</script>
{% endblock %}
