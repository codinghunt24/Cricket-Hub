{% extends 'admin/base.html' %}

{% block title %}Teams - Admin Panel{% endblock %}
{% block page_title %}Teams Management{% endblock %}

{% block content %}
<div class="admin-page">
    <div id="scrapeStatus" class="scrape-status-bar" style="display:none;"></div>
<div id="autoScrapeStatus" class="scrape-status-bar" style="display:none;"></div>
<div class="scrape-controls">
        <div class="control-header">
            <h2>Scrape Controls</h2>
            <div class="control-buttons">
                <button class="btn btn-primary" onclick="scrapeAll()">Scrape All Categories</button>
                <button class="btn btn-danger" onclick="clearAllTeams()">Clear All Teams</button>
            </div>
        </div>
        
        <div class="server-time-display">
            <span class="server-time-label">Server Time:</span>
            <span id="serverClock" class="server-clock">--:--:--</span>
        </div>
        
        <div class="scrape-sections-row">
            <div class="scrape-section">
                <h3>Teams (All)</h3>
                <div class="scrape-row">
                    <label class="toggle-label">
                        <input type="checkbox" id="autoScrapeToggle" {% if setting and setting.auto_scrape_enabled %}checked{% endif %} onchange="toggleAutoScrape()">
                        <span class="toggle-text">Auto</span>
                    </label>
                    <input type="time" id="scrapeTime" value="{{ setting.scrape_time if setting else '02:00' }}" class="time-input-sm">
                </div>
                {% if setting and setting.last_scrape %}
                <span class="last-scrape-sm">Last: {{ setting.last_scrape.strftime('%d %b, %H:%M') }}</span>
                {% endif %}
            </div>
            
            <div class="scrape-section">
                <h3>Players (All)</h3>
                <button class="btn btn-sm btn-secondary" onclick="scrapeAllPlayers()">Scrape All</button>
                <div class="scrape-row">
                    <label class="toggle-label">
                        <input type="checkbox" id="playerAutoScrapeToggle" {% if setting and setting.player_auto_scrape_enabled %}checked{% endif %} onchange="togglePlayerAutoScrape()">
                        <span class="toggle-text">Auto</span>
                    </label>
                    <input type="time" id="playerScrapeTime" value="{{ setting.player_scrape_time if setting else '03:00' }}" class="time-input-sm">
                </div>
                {% if setting and setting.last_player_scrape %}
                <span class="last-scrape-sm">Last: {{ setting.last_player_scrape.strftime('%d %b, %H:%M') }}</span>
                {% endif %}
            </div>
        </div>
        
        <h3 class="section-subtitle">Players by Category</h3>
        <div class="scrape-sections-row category-row">
            <div class="scrape-section-cat">
                <div class="cat-header">üåç International</div>
                <button class="btn btn-xs" onclick="scrapeCategoryPlayers('international')">Scrape Now</button>
                <div class="cat-auto">
                    <label><input type="checkbox" id="autoIntl" {% if setting and setting.intl_auto %}checked{% endif %} onchange="saveCategoryAuto('international')"> Auto</label>
                    <input type="time" id="timeIntl" value="{{ setting.intl_time if setting and setting.intl_time else '04:00' }}" class="time-xs" onchange="saveCategoryAuto('international')">
                </div>
            </div>
            <div class="scrape-section-cat">
                <div class="cat-header">üè† Domestic</div>
                <button class="btn btn-xs" onclick="scrapeCategoryPlayers('domestic')">Scrape Now</button>
                <div class="cat-auto">
                    <label><input type="checkbox" id="autoDomestic" {% if setting and setting.domestic_auto %}checked{% endif %} onchange="saveCategoryAuto('domestic')"> Auto</label>
                    <input type="time" id="timeDomestic" value="{{ setting.domestic_time if setting and setting.domestic_time else '05:00' }}" class="time-xs" onchange="saveCategoryAuto('domestic')">
                </div>
            </div>
            <div class="scrape-section-cat">
                <div class="cat-header">üèÜ League</div>
                <button class="btn btn-xs" onclick="scrapeCategoryPlayers('league')">Scrape Now</button>
                <div class="cat-auto">
                    <label><input type="checkbox" id="autoLeague" {% if setting and setting.league_auto %}checked{% endif %} onchange="saveCategoryAuto('league')"> Auto</label>
                    <input type="time" id="timeLeague" value="{{ setting.league_time if setting and setting.league_time else '06:00' }}" class="time-xs" onchange="saveCategoryAuto('league')">
                </div>
            </div>
            <div class="scrape-section-cat">
                <div class="cat-header">üë© Women</div>
                <button class="btn btn-xs" onclick="scrapeCategoryPlayers('women')">Scrape Now</button>
                <div class="cat-auto">
                    <label><input type="checkbox" id="autoWomen" {% if setting and setting.women_auto %}checked{% endif %} onchange="saveCategoryAuto('women')"> Auto</label>
                    <input type="time" id="timeWomen" value="{{ setting.women_time if setting and setting.women_time else '07:00' }}" class="time-xs" onchange="saveCategoryAuto('women')">
                </div>
            </div>
        </div>
    </div>
    
    <div class="categories-section">
        <h2>Categories</h2>
        <div class="category-cards">
            {% for item in category_data %}
            <div class="category-admin-card">
                <div class="category-header">
                    <h3>{{ item.category.name }}</h3>
                    <span class="team-count">{{ item.team_count }} teams</span>
                </div>
                <div class="category-actions">
                    <button class="btn btn-secondary" onclick="scrapeCategory('{{ item.category.slug }}')">
                        Scrape Teams
                    </button>
                </div>
                
                {% if item.teams %}
                <div class="teams-list">
                    {% for team in item.teams %}
                    <div class="team-item">
                        <div class="team-info">
                            {% if team.flag_url %}
                            <img src="{{ team.flag_url }}" alt="{{ team.name }}" class="team-flag-small">
                            {% endif %}
                            <span class="team-name">{{ team.name }}</span>
                        </div>
                        <button class="btn btn-small" onclick="scrapePlayers({{ team.id }})">
                            Scrape Players
                        </button>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>
    
    <div class="scrape-logs">
        <h2>Recent Scrape Logs</h2>
        <div class="logs-table">
            {% if recent_logs %}
            <table>
                <thead>
                    <tr>
                        <th>Time</th>
                        <th>Category</th>
                        <th>Status</th>
                        <th>Message</th>
                    </tr>
                </thead>
                <tbody>
                    {% for log in recent_logs %}
                    <tr class="log-{{ log.status }}">
                        <td>{{ log.created_at.strftime('%d %b, %H:%M') }}</td>
                        <td>{{ log.category }}</td>
                        <td><span class="status-badge {{ log.status }}">{{ log.status }}</span></td>
                        <td>{{ log.message }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <p class="no-logs">No scrape logs yet</p>
            {% endif %}
        </div>
    </div>
</div>

<div id="loadingOverlay" class="loading-overlay" style="display:none;">
    <div class="loading-spinner"></div>
    <p>Scraping in progress...</p>
</div>

<script>
function showLoading() {
    document.getElementById('loadingOverlay').style.display = 'flex';
}

function hideLoading() {
    document.getElementById('loadingOverlay').style.display = 'none';
}

function scrapeCategory(slug) {
    showLoading();
    fetch('/api/scrape/category/' + slug, { method: 'POST' })
        .then(res => res.json())
        .then(data => {
            hideLoading();
            alert(data.message);
            if (data.success) location.reload();
        })
        .catch(err => {
            hideLoading();
            alert('Error: ' + err.message);
        });
}

function scrapeAll() {
    showLoading();
    fetch('/api/scrape/all', { method: 'POST' })
        .then(res => res.json())
        .then(data => {
            hideLoading();
            alert(data.message);
            if (data.success) location.reload();
        })
        .catch(err => {
            hideLoading();
            alert('Error: ' + err.message);
        });
}

function clearAllTeams() {
    if (!confirm('Are you sure? This will delete ALL teams and players from the database!')) return;
    
    showLoading();
    fetch('/api/teams/clear-all', { method: 'DELETE' })
        .then(res => res.json())
        .then(data => {
            hideLoading();
            alert(data.message);
            if (data.success) location.reload();
        })
        .catch(err => {
            hideLoading();
            alert('Error: ' + err.message);
        });
}

function scrapePlayers(teamId) {
    showLoading();
    fetch('/api/scrape/team/' + teamId + '/players', { method: 'POST' })
        .then(res => res.json())
        .then(data => {
            hideLoading();
            alert(data.message);
        })
        .catch(err => {
            hideLoading();
            alert('Error: ' + err.message);
        });
}

function toggleAutoScrape() {
    const enabled = document.getElementById('autoScrapeToggle').checked;
    const scrapeTime = document.getElementById('scrapeTime').value;
    
    fetch('/api/settings/auto-scrape', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ enabled: enabled, scrape_time: scrapeTime })
    })
    .then(res => res.json())
    .then(data => {
        alert(data.message);
    })
    .catch(err => alert('Error: ' + err.message));
}

function scrapeAllPlayers() {
    showLoading();
    fetch('/api/scrape/all-players', { method: 'POST' })
        .then(res => res.json())
        .then(data => {
            hideLoading();
            alert(data.message);
            if (data.success) location.reload();
        })
        .catch(err => {
            hideLoading();
            alert('Error: ' + err.message);
        });
}

function scrapeCategoryPlayers(categorySlug) {
    const statusDiv = document.getElementById('scrapeStatus');
    statusDiv.innerHTML = `
        <div class="scrape-progress-bar">
            <div class="progress-info">
                <span>Scraping ${categorySlug} players...</span>
                <span id="progressPercent">0%</span>
            </div>
            <div class="progress-track">
                <div class="progress-fill" id="progressFill" style="width: 0%"></div>
            </div>
            <div class="progress-detail" id="progressDetail">Starting...</div>
        </div>`;
    statusDiv.style.display = 'block';
    
    const progressInterval = setInterval(() => {
        fetch('/api/scrape/category/' + categorySlug + '/players/progress')
            .then(res => res.json())
            .then(prog => {
                document.getElementById('progressPercent').textContent = prog.percent + '%';
                document.getElementById('progressFill').style.width = prog.percent + '%';
                if (prog.team) {
                    document.getElementById('progressDetail').textContent = `Team ${prog.current}/${prog.total}: ${prog.team}`;
                }
                if (prog.status === 'complete') {
                    clearInterval(progressInterval);
                }
            });
    }, 500);
    
    fetch('/api/scrape/category/' + categorySlug + '/players', { method: 'POST' })
        .then(res => res.json())
        .then(data => {
            clearInterval(progressInterval);
            document.getElementById('progressPercent').textContent = '100%';
            document.getElementById('progressFill').style.width = '100%';
            statusDiv.innerHTML = '<div class="scrape-success">' + data.message + '</div>';
            setTimeout(() => { statusDiv.style.display = 'none'; location.reload(); }, 2000);
        })
        .catch(err => {
            clearInterval(progressInterval);
            statusDiv.innerHTML = '<div class="scrape-error">Error: ' + err.message + '</div>';
        });
}

function saveCategoryAuto(category) {
    const catMap = {
        'international': 'Intl',
        'domestic': 'Domestic', 
        'league': 'League',
        'women': 'Women'
    };
    const suffix = catMap[category];
    const enabled = document.getElementById('auto' + suffix).checked;
    const time = document.getElementById('time' + suffix).value;
    
    fetch('/api/settings/category-auto-scrape', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ category: category, enabled: enabled, scrape_time: time })
    })
    .then(res => res.json())
    .then(data => alert(data.message))
    .catch(err => alert('Error: ' + err.message));
}

function togglePlayerAutoScrape() {
    const enabled = document.getElementById('playerAutoScrapeToggle').checked;
    const scrapeTime = document.getElementById('playerScrapeTime').value;
    
    fetch('/api/settings/player-auto-scrape', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ enabled: enabled, scrape_time: scrapeTime })
    })
    .then(res => res.json())
    .then(data => {
        alert(data.message);
    })
    .catch(err => alert('Error: ' + err.message));
}

function updateServerClock() {
    fetch('/api/server-time')
        .then(res => res.json())
        .then(data => {
            document.getElementById('serverClock').textContent = data.time;
        });
}

updateServerClock();
setInterval(updateServerClock, 1000);

function checkAutoScrapeProgress() {
    const categories = ['international', 'domestic', 'league', 'women'];
    categories.forEach(cat => {
        fetch('/api/scrape/category/' + cat + '/players/progress')
            .then(res => res.json())
            .then(prog => {
                if (prog.status === 'running') {
                    const statusDiv = document.getElementById('autoScrapeStatus');
                    statusDiv.style.display = 'block';
                    statusDiv.innerHTML = `
                        <div class="scrape-progress-bar">
                            <div class="progress-info">
                                <span>Auto Scraping ${cat} players...</span>
                                <span>${prog.percent}%</span>
                            </div>
                            <div class="progress-track">
                                <div class="progress-fill" style="width: ${prog.percent}%"></div>
                            </div>
                            <div class="progress-detail">Team ${prog.current}/${prog.total}: ${prog.team || 'Starting...'}</div>
                        </div>`;
                } else if (prog.status === 'complete' && prog.percent === 100) {
                    const statusDiv = document.getElementById('autoScrapeStatus');
                    if (statusDiv.style.display === 'block') {
                        statusDiv.innerHTML = '<div class="scrape-success">Auto scrape completed!</div>';
                        setTimeout(() => { statusDiv.style.display = 'none'; location.reload(); }, 2000);
                    }
                }
            });
    });
}
setInterval(checkAutoScrapeProgress, 1000);
</script>
{% endblock %}
