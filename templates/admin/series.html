{% extends 'admin/base.html' %}

{% block title %}Series - Admin Panel{% endblock %}
{% block page_title %}Series{% endblock %}

{% block content %}
<div class="admin-page">
    <div class="scrape-tab">
        <div class="url-input-group">
            <input type="text" id="series-url" class="url-input" 
                   value="https://www.cricbuzz.com/cricket-schedule/series/international" 
                   placeholder="Enter Cricbuzz series URL">
            <button class="btn-scrape" onclick="scrapeSeriesFromUrl()">
                <i class="fas fa-download"></i> Scrape
            </button>
        </div>
    </div>
    
    <div class="data-preview" id="data-preview">
        <div class="preview-header">
            <h3>JSON Data Preview</h3>
            <span class="badge" id="series-count">0 series</span>
        </div>
        <div class="preview-content" id="preview-content">
            <p class="hint-text">Click "Scrape" to fetch series data from URL</p>
        </div>
    </div>
</div>

<style>
.scrape-tab {
    background: #1f2937;
    padding: 12px;
    border-radius: 6px;
    margin-bottom: 15px;
    border: 1px solid #374151;
}

.url-input-group {
    display: flex;
    gap: 10px;
    align-items: center;
}

.url-input {
    flex: 1;
    padding: 8px 12px;
    background: #111827;
    border: 1px solid #374151;
    border-radius: 4px;
    color: #e4e4e7;
    font-size: 12px;
    font-family: monospace;
}

.url-input:focus {
    outline: none;
    border-color: #10b981;
}

.btn-scrape {
    background: #10b981;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 4px;
    font-size: 12px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 6px;
    font-weight: 600;
}

.btn-scrape:hover {
    background: #059669;
}

.btn-scrape:disabled {
    background: #374151;
    cursor: not-allowed;
}

.data-preview {
    background: #1f2937;
    border-radius: 6px;
    border: 1px solid #374151;
    overflow: hidden;
}

.preview-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 15px;
    background: #111827;
    border-bottom: 1px solid #374151;
}

.preview-header h3 {
    margin: 0;
    font-size: 13px;
    color: #e4e4e7;
}

.badge {
    background: #10b981;
    color: white;
    padding: 3px 8px;
    border-radius: 10px;
    font-size: 10px;
    font-weight: 600;
}

.preview-content {
    padding: 15px;
    max-height: 500px;
    overflow-y: auto;
}

.hint-text {
    color: #9ca3af;
    font-size: 12px;
    text-align: center;
    margin: 20px 0;
}

.series-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 11px;
}

.series-table th {
    background: #111827;
    color: #e4e4e7;
    padding: 8px 10px;
    text-align: left;
    font-weight: 600;
    font-size: 10px;
    text-transform: uppercase;
    position: sticky;
    top: 0;
}

.series-table td {
    padding: 6px 10px;
    border-bottom: 1px solid #374151;
    color: #e4e4e7;
}

.series-table tbody tr:hover {
    background: #374151;
}

.series-table .id-col {
    color: #10b981;
    font-family: monospace;
    font-size: 10px;
    width: 70px;
}

.series-table .name-col {
    font-weight: 500;
}

.series-table .url-col {
    font-family: monospace;
    font-size: 9px;
    color: #9ca3af;
    max-width: 300px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.series-table .url-col a {
    color: #60a5fa;
    text-decoration: none;
}

.series-table .url-col a:hover {
    text-decoration: underline;
}

.loading {
    text-align: center;
    padding: 30px;
    color: #9ca3af;
}

.loading i {
    font-size: 24px;
    margin-bottom: 10px;
    display: block;
    color: #10b981;
}

.matches-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 10px;
}

.matches-table th {
    background: #111827;
    color: #e4e4e7;
    padding: 6px 8px;
    text-align: left;
    font-weight: 600;
    font-size: 9px;
    text-transform: uppercase;
    position: sticky;
    top: 0;
}

.matches-table td {
    padding: 5px 8px;
    border-bottom: 1px solid #374151;
    color: #e4e4e7;
}

.matches-table tbody tr:hover {
    background: #374151;
}

.matches-table .format-col {
    color: #10b981;
    font-weight: 600;
    width: 80px;
}

.matches-table .date-col {
    color: #9ca3af;
    font-size: 9px;
    width: 120px;
}

.matches-table .teams-col {
    font-weight: 500;
}

.matches-table .score-col {
    font-family: monospace;
    font-size: 9px;
}

.matches-table .result-col {
    color: #fbbf24;
    font-size: 9px;
    max-width: 150px;
}
</style>

<script>
async function scrapeSeriesFromUrl() {
    const urlInput = document.getElementById('series-url');
    const btn = document.querySelector('.btn-scrape');
    const previewContent = document.getElementById('preview-content');
    const countBadge = document.getElementById('series-count');
    
    const url = urlInput.value.trim();
    if (!url) {
        alert('Please enter a URL');
        return;
    }
    
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Scraping...';
    previewContent.innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i>Fetching data from Cricbuzz...</div>';
    
    try {
        const response = await fetch('/api/scrape/series-json', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ url: url })
        });
        
        const data = await response.json();
        
        if (data.success) {
            if (data.type === 'matches' && data.matches && data.matches.length > 0) {
                countBadge.textContent = data.matches.length + ' matches';
                
                let html = '<table class="matches-table"><thead><tr>';
                html += '<th>Format</th>';
                html += '<th>Date</th>';
                html += '<th>Teams</th>';
                html += '<th>Score</th>';
                html += '<th>Result</th>';
                html += '</tr></thead><tbody>';
                
                data.matches.forEach(m => {
                    html += `<tr>
                        <td class="format-col">${m.match_format || '-'}</td>
                        <td class="date-col">${m.match_date || '-'}</td>
                        <td class="teams-col">${m.team1 || '?'} vs ${m.team2 || '?'}</td>
                        <td class="score-col">${m.team1_score || '-'} vs ${m.team2_score || '-'}</td>
                        <td class="result-col">${m.result || '-'}</td>
                    </tr>`;
                });
                
                html += '</tbody></table>';
                previewContent.innerHTML = html;
                
            } else if (data.series && data.series.length > 0) {
                countBadge.textContent = data.series.length + ' series';
                
                let html = '<table class="series-table"><thead><tr>';
                html += '<th>ID</th>';
                html += '<th>Series Name</th>';
                html += '<th>URL</th>';
                html += '</tr></thead><tbody>';
                
                data.series.forEach(s => {
                    html += `<tr>
                        <td class="id-col">${s.id}</td>
                        <td class="name-col">${s.name}</td>
                        <td class="url-col"><a href="${s.url}" target="_blank">${s.url}</a></td>
                    </tr>`;
                });
                
                html += '</tbody></table>';
                previewContent.innerHTML = html;
            } else {
                previewContent.innerHTML = '<p class="hint-text">No data found</p>';
                countBadge.textContent = '0';
            }
        } else {
            previewContent.innerHTML = '<p class="hint-text">Error: ' + (data.message || 'Unknown error') + '</p>';
        }
    } catch (error) {
        previewContent.innerHTML = '<p class="hint-text">Error: ' + error.message + '</p>';
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-download"></i> Scrape';
    }
}
</script>
{% endblock %}
