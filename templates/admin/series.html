{% extends 'admin/base.html' %}

{% block title %}Series - Admin Panel{% endblock %}
{% block page_title %}Series{% endblock %}

{% block content %}
<div class="admin-page">
    <div class="scrape-tab">
        <div class="url-input-group">
            <input type="text" id="series-url" class="url-input" 
                   value="https://www.cricbuzz.com/cricket-schedule/series/international" 
                   placeholder="Enter Cricbuzz series URL">
            <button class="btn-scrape" onclick="scrapeSeriesFromUrl()">
                <i class="fas fa-download"></i> Scrape
            </button>
        </div>
    </div>
    
    <div class="data-preview" id="data-preview">
        <div class="preview-header">
            <h3>JSON Data Preview</h3>
            <span class="badge" id="series-count">0 series</span>
            <button class="btn-save" id="btn-save-all" onclick="saveAllToDb()" style="display:none;">
                <i class="fas fa-database"></i> Save All to DB
            </button>
        </div>
        <div class="preview-content" id="preview-content">
            <p class="hint-text">Click "Scrape" to fetch series data from URL</p>
        </div>
    </div>
</div>

<style>
.scrape-tab {
    background: #1f2937;
    padding: 12px;
    border-radius: 6px;
    margin-bottom: 15px;
    border: 1px solid #374151;
}

.url-input-group {
    display: flex;
    gap: 10px;
    align-items: center;
}

.url-input {
    flex: 1;
    padding: 8px 12px;
    background: #111827;
    border: 1px solid #374151;
    border-radius: 4px;
    color: #e4e4e7;
    font-size: 12px;
    font-family: monospace;
}

.url-input:focus {
    outline: none;
    border-color: #10b981;
}

.btn-scrape {
    background: #10b981;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 4px;
    font-size: 12px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 6px;
    font-weight: 600;
}

.btn-scrape:hover {
    background: #059669;
}

.btn-scrape:disabled {
    background: #374151;
    cursor: not-allowed;
}

.btn-save {
    background: #8b5cf6;
    color: white;
    border: none;
    padding: 6px 12px;
    border-radius: 4px;
    font-size: 11px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 5px;
    font-weight: 600;
}

.btn-save:hover {
    background: #7c3aed;
}

.btn-save:disabled {
    background: #374151;
    cursor: not-allowed;
}

.btn-save-sm {
    background: #8b5cf6;
    color: white;
    border: none;
    padding: 3px 8px;
    border-radius: 3px;
    font-size: 9px;
    cursor: pointer;
    font-weight: 500;
    margin-left: 5px;
}

.btn-save-sm:hover {
    background: #7c3aed;
}

.btn-match {
    background: #3b82f6;
    color: white;
    border: none;
    padding: 4px 10px;
    border-radius: 3px;
    font-size: 10px;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 4px;
    font-weight: 500;
}

.btn-match:hover {
    background: #2563eb;
}

.btn-match:disabled {
    background: #374151;
    cursor: not-allowed;
}

.btn-match.expanded {
    background: #ef4444;
}

.data-preview {
    background: #1f2937;
    border-radius: 6px;
    border: 1px solid #374151;
    overflow: hidden;
}

.preview-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 15px;
    background: #111827;
    border-bottom: 1px solid #374151;
}

.preview-header h3 {
    margin: 0;
    font-size: 13px;
    color: #e4e4e7;
}

.badge {
    background: #10b981;
    color: white;
    padding: 3px 8px;
    border-radius: 10px;
    font-size: 10px;
    font-weight: 600;
}

.preview-content {
    padding: 15px;
    max-height: 600px;
    overflow-y: auto;
}

.hint-text {
    color: #9ca3af;
    font-size: 12px;
    text-align: center;
    margin: 20px 0;
}

.series-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 11px;
}

.series-table th {
    background: #111827;
    color: #e4e4e7;
    padding: 8px 10px;
    text-align: left;
    font-weight: 600;
    font-size: 10px;
    text-transform: uppercase;
    position: sticky;
    top: 0;
}

.series-table td {
    padding: 6px 10px;
    border-bottom: 1px solid #374151;
    color: #e4e4e7;
    vertical-align: middle;
}

.series-table tbody tr:hover {
    background: #374151;
}

.series-table .id-col {
    color: #10b981;
    font-family: monospace;
    font-size: 10px;
    width: 70px;
}

.series-table .name-col {
    font-weight: 500;
}

.series-table .month-col {
    color: #fbbf24;
    font-weight: 600;
    font-size: 10px;
    white-space: nowrap;
}

.series-table .action-col {
    width: 100px;
    text-align: center;
}

.loading {
    text-align: center;
    padding: 30px;
    color: #9ca3af;
}

.loading i {
    font-size: 24px;
    margin-bottom: 10px;
    display: block;
    color: #10b981;
}

.matches-dropdown {
    display: none;
    background: #111827;
    border-top: 1px solid #374151;
}

.matches-dropdown.show {
    display: table-row;
}

.matches-dropdown td {
    padding: 0;
}

.matches-container {
    padding: 10px 15px;
    background: #111827;
}

.matches-loading {
    text-align: center;
    padding: 15px;
    color: #9ca3af;
    font-size: 11px;
}

.matches-list {
    width: 100%;
    border-collapse: collapse;
    font-size: 10px;
}

.matches-list th {
    background: #1f2937;
    color: #9ca3af;
    padding: 6px 8px;
    text-align: left;
    font-weight: 600;
    font-size: 9px;
    text-transform: uppercase;
}

.matches-list td {
    padding: 5px 8px;
    border-bottom: 1px solid #374151;
    color: #e4e4e7;
}

.matches-list tbody tr:hover {
    background: #1f2937;
}

.matches-list .match-id {
    color: #10b981;
    font-family: monospace;
    font-size: 9px;
    width: 60px;
}

.matches-list .match-format {
    color: #3b82f6;
    font-weight: 600;
    width: 80px;
}

.matches-list .match-date {
    color: #9ca3af;
    font-size: 9px;
    width: 100px;
}

.matches-list .match-teams {
    font-weight: 500;
}

.matches-list .match-venue {
    color: #9ca3af;
    font-size: 9px;
    max-width: 150px;
}

.matches-list .match-score {
    font-family: monospace;
    font-size: 9px;
}

.matches-list .match-result {
    color: #fbbf24;
    font-size: 9px;
    max-width: 120px;
}

.matches-list .match-id {
    color: #60a5fa;
    font-weight: 500;
    width: 60px;
}

.matches-list .match-action {
    text-align: center;
    width: 70px;
}

.btn-scrape-match {
    background: #3b82f6;
    color: white;
    border: none;
    padding: 3px 8px;
    border-radius: 3px;
    font-size: 9px;
    cursor: pointer;
    font-weight: 500;
}

.btn-scrape-match:hover {
    background: #2563eb;
}

.btn-scrape-match:disabled {
    background: #374151;
    cursor: not-allowed;
}

.btn-scrape-match.active {
    background: #ef4444;
}

.match-details-row {
    background: #0f172a;
}

.match-details-container {
    padding: 10px;
    font-size: 10px;
}

.match-json-data {
    background: #1e293b;
    padding: 10px;
    border-radius: 4px;
    max-height: 300px;
    overflow-y: auto;
}

.match-json-data table {
    width: 100%;
    border-collapse: collapse;
}

.match-json-data th {
    background: #334155;
    padding: 5px 8px;
    text-align: left;
    font-size: 9px;
    color: #94a3b8;
}

.match-json-data td {
    padding: 4px 8px;
    border-bottom: 1px solid #334155;
    color: #e2e8f0;
    font-size: 9px;
}

.no-matches {
    text-align: center;
    padding: 15px;
    color: #9ca3af;
    font-size: 11px;
}
</style>

<script>
let seriesData = [];
let matchesData = {};
let currentSeriesUrl = '';

async function saveAllToDb() {
    const btn = document.getElementById('btn-save-all');
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
    
    try {
        const response = await fetch('/api/save/series-matches', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ series: seriesData })
        });
        
        const data = await response.json();
        if (data.success) {
            btn.innerHTML = '<i class="fas fa-check"></i> Saved ' + data.saved_series + ' series';
            btn.style.background = '#10b981';
            setTimeout(() => {
                btn.innerHTML = '<i class="fas fa-database"></i> Save All to DB';
                btn.style.background = '#8b5cf6';
                btn.disabled = false;
            }, 2000);
        } else {
            alert('Error: ' + data.message);
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-database"></i> Save All to DB';
        }
    } catch (error) {
        alert('Error: ' + error.message);
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-database"></i> Save All to DB';
    }
}

async function saveMatchesToDb(index, url) {
    const btn = document.getElementById(`btn-save-matches-${index}`);
    const matches = matchesData[index];
    
    if (!matches || matches.length === 0) {
        alert('No matches to save. Scrape matches first.');
        return;
    }
    
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    
    try {
        const response = await fetch('/api/save/series-matches', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ matches: matches, series_url: url })
        });
        
        const data = await response.json();
        if (data.success) {
            btn.innerHTML = '<i class="fas fa-check"></i> ' + data.saved_matches;
            btn.style.background = '#10b981';
        } else {
            alert('Error: ' + data.message);
            btn.innerHTML = '<i class="fas fa-database"></i> Save';
        }
    } catch (error) {
        alert('Error: ' + error.message);
        btn.innerHTML = '<i class="fas fa-database"></i> Save';
    } finally {
        btn.disabled = false;
    }
}

async function scrapeSeriesFromUrl() {
    const urlInput = document.getElementById('series-url');
    const btn = document.querySelector('.btn-scrape');
    const previewContent = document.getElementById('preview-content');
    const countBadge = document.getElementById('series-count');
    
    const url = urlInput.value.trim();
    if (!url) {
        alert('Please enter a URL');
        return;
    }
    
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Scraping...';
    previewContent.innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i>Fetching data from Cricbuzz...</div>';
    
    try {
        const response = await fetch('/api/scrape/series-json', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ url: url })
        });
        
        const data = await response.json();
        
        if (data.success && data.series && data.series.length > 0) {
            seriesData = data.series;
            countBadge.textContent = data.series.length + ' series';
            document.getElementById('btn-save-all').style.display = 'flex';
            
            let html = '<table class="series-table"><thead><tr>';
            html += '<th>ID</th>';
            html += '<th>Series Name</th>';
            html += '<th>Month</th>';
            html += '<th>Action</th>';
            html += '</tr></thead><tbody>';
            
            data.series.forEach((s, index) => {
                html += `<tr id="series-row-${index}">
                    <td class="id-col">${s.id}</td>
                    <td class="name-col">${s.name}</td>
                    <td class="month-col">${s.month_year || '-'}</td>
                    <td class="action-col">
                        <button class="btn-match" id="btn-${index}" onclick="toggleMatches(${index}, '${s.url}')">
                            <i class="fas fa-cricket-bat-ball"></i> Matches
                        </button>
                        <button class="btn-save-sm" id="btn-save-matches-${index}" onclick="saveMatchesToDb(${index}, '${s.url}')" title="Save matches to DB">
                            <i class="fas fa-database"></i>
                        </button>
                    </td>
                </tr>
                <tr class="matches-dropdown" id="matches-row-${index}">
                    <td colspan="4">
                        <div class="matches-container" id="matches-container-${index}">
                        </div>
                    </td>
                </tr>`;
            });
            
            html += '</tbody></table>';
            previewContent.innerHTML = html;
        } else {
            previewContent.innerHTML = '<p class="hint-text">No series found</p>';
            countBadge.textContent = '0';
        }
    } catch (error) {
        previewContent.innerHTML = '<p class="hint-text">Error: ' + error.message + '</p>';
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-download"></i> Scrape';
    }
}

async function toggleMatches(index, url) {
    const matchesRow = document.getElementById(`matches-row-${index}`);
    const container = document.getElementById(`matches-container-${index}`);
    const btn = document.getElementById(`btn-${index}`);
    
    if (matchesRow.classList.contains('show')) {
        matchesRow.classList.remove('show');
        btn.classList.remove('expanded');
        btn.innerHTML = '<i class="fas fa-cricket-bat-ball"></i> Scrape Match';
        return;
    }
    
    matchesRow.classList.add('show');
    btn.classList.add('expanded');
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';
    container.innerHTML = '<div class="matches-loading"><i class="fas fa-spinner fa-spin"></i> Fetching matches...</div>';
    
    try {
        const response = await fetch('/api/scrape/series-json', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ url: url })
        });
        
        const data = await response.json();
        
        if (data.success && data.type === 'matches' && data.matches && data.matches.length > 0) {
            matchesData[index] = data.matches;
            let html = '<table class="matches-list"><thead><tr>';
            html += '<th>ID</th>';
            html += '<th>Date</th>';
            html += '<th>Format</th>';
            html += '<th>Teams</th>';
            html += '<th>Venue</th>';
            html += '<th>Score</th>';
            html += '<th>Result</th>';
            html += '<th>Action</th>';
            html += '</tr></thead><tbody>';
            
            data.matches.forEach((m, idx) => {
                const matchRowId = `match-${index}-${idx}`;
                html += `<tr id="${matchRowId}">
                    <td class="match-id">${m.match_id || '-'}</td>
                    <td class="match-date">${m.match_date || '-'}</td>
                    <td class="match-format">${m.match_format || '-'}</td>
                    <td class="match-teams">${m.team1 || '?'} vs ${m.team2 || '?'}</td>
                    <td class="match-venue">${m.venue || '-'}</td>
                    <td class="match-score">${m.team1_score || '-'}<br>${m.team2_score || '-'}</td>
                    <td class="match-result">${m.result || '-'}</td>
                    <td class="match-action">
                        <button class="btn-scrape-match" id="btn-match-${index}-${idx}" onclick="scrapeMatchDetails('${m.match_id}', '${matchRowId}', ${index}, ${idx})">
                            Scrape
                        </button>
                    </td>
                </tr>
                <tr class="match-details-row" id="details-${matchRowId}" style="display:none;">
                    <td colspan="8">
                        <div class="match-details-container" id="details-container-${matchRowId}"></div>
                    </td>
                </tr>`;
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
            btn.innerHTML = '<i class="fas fa-times"></i> Close';
        } else {
            container.innerHTML = '<div class="no-matches">No matches found</div>';
            btn.innerHTML = '<i class="fas fa-times"></i> Close';
        }
    } catch (error) {
        container.innerHTML = '<div class="no-matches">Error: ' + error.message + '</div>';
        btn.innerHTML = '<i class="fas fa-times"></i> Close';
    } finally {
        btn.disabled = false;
    }
}

async function scrapeMatchDetails(matchId, matchRowId, seriesIdx, matchIdx) {
    const detailsRow = document.getElementById(`details-${matchRowId}`);
    const container = document.getElementById(`details-container-${matchRowId}`);
    const btn = document.getElementById(`btn-match-${seriesIdx}-${matchIdx}`);
    
    if (detailsRow.style.display !== 'none') {
        detailsRow.style.display = 'none';
        btn.textContent = 'Scrape';
        btn.classList.remove('active');
        return;
    }
    
    detailsRow.style.display = 'table-row';
    btn.disabled = true;
    btn.textContent = 'Loading...';
    container.innerHTML = '<div style="color:#9ca3af;text-align:center;padding:10px;">Fetching scorecard from cricbuzz.com/live-cricket-scorecard/' + matchId + '...</div>';
    
    try {
        const response = await fetch('/api/scrape/match-json', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ match_id: matchId })
        });
        
        const data = await response.json();
        
        if (data.success && data.data) {
            let html = '<div class="match-json-data">';
            
            html += '<div class="scorecard-header" style="margin-bottom:10px;padding:8px;background:#1e3a5f;border-radius:4px;">';
            html += `<div style="font-size:11px;color:#10b981;font-weight:600;">${data.data.series || ''}</div>`;
            html += `<div style="font-size:10px;color:#e2e8f0;">${data.data.match || ''} - ${data.data.format || ''}</div>`;
            html += `<div style="font-size:10px;color:#94a3b8;">${data.data.venue || ''}</div>`;
            html += `<div style="font-size:9px;color:#60a5fa;margin-top:4px;">${data.data.toss || ''}</div>`;
            html += `<div style="font-size:10px;color:#fbbf24;font-weight:500;margin-top:4px;">${data.data.status || ''}</div>`;
            html += '</div>';
            
            html += '<div style="display:flex;gap:10px;margin-bottom:10px;">';
            html += `<div style="flex:1;background:#1e293b;padding:6px;border-radius:4px;text-align:center;">`;
            html += `<div style="color:#94a3b8;font-size:9px;">${data.data.team1 || 'Team 1'}</div>`;
            html += `<div style="color:#10b981;font-size:12px;font-weight:600;">${data.data.team1_score || '-'}</div>`;
            html += `</div>`;
            html += `<div style="flex:1;background:#1e293b;padding:6px;border-radius:4px;text-align:center;">`;
            html += `<div style="color:#94a3b8;font-size:9px;">${data.data.team2 || 'Team 2'}</div>`;
            html += `<div style="color:#10b981;font-size:12px;font-weight:600;">${data.data.team2_score || '-'}</div>`;
            html += `</div>`;
            html += '</div>';
            
            if (data.data.batting && data.data.batting.length > 0) {
                html += '<h4 style="color:#10b981;margin:10px 0 5px;font-size:10px;">Batting</h4>';
                html += '<table><tr><th>Batter</th><th>R</th><th>B</th><th>4s</th><th>6s</th><th>SR</th><th>Dismissal</th></tr>';
                data.data.batting.forEach(b => {
                    html += `<tr><td>${b.name}</td><td style="color:#fbbf24;font-weight:500;">${b.runs}</td><td>${b.balls}</td><td>${b.fours}</td><td>${b.sixes}</td><td>${b.sr}</td><td style="color:#94a3b8;font-size:8px;">${b.status}</td></tr>`;
                });
                html += '</table>';
            }
            
            if (data.data.bowling && data.data.bowling.length > 0) {
                html += '<h4 style="color:#10b981;margin:10px 0 5px;font-size:10px;">Bowling</h4>';
                html += '<table><tr><th>Bowler</th><th>O</th><th>M</th><th>R</th><th>W</th><th>Eco</th></tr>';
                data.data.bowling.forEach(b => {
                    html += `<tr><td>${b.name}</td><td>${b.overs}</td><td>${b.maidens}</td><td>${b.runs}</td><td style="color:#ef4444;font-weight:500;">${b.wickets}</td><td>${b.economy}</td></tr>`;
                });
                html += '</table>';
            }
            
            html += '</div>';
            container.innerHTML = html;
            btn.textContent = 'Close';
            btn.classList.add('active');
        } else {
            container.innerHTML = '<div style="color:#ef4444;text-align:center;padding:10px;">No data found</div>';
            btn.textContent = 'Close';
            btn.classList.add('active');
        }
    } catch (error) {
        container.innerHTML = `<div style="color:#ef4444;text-align:center;padding:10px;">Error: ${error.message}</div>`;
        btn.textContent = 'Close';
        btn.classList.add('active');
    } finally {
        btn.disabled = false;
    }
}
</script>
{% endblock %}
