{% extends 'admin/base.html' %}

{% block title %}Scorecard - Admin Panel{% endblock %}
{% block page_title %}Scorecard{% endblock %}

{% block content %}
<div class="admin-page">
    <div class="scrape-section">
        <h3>View Scorecard</h3>
        <div class="input-group">
            <div class="input-row">
                <label>Match ID</label>
                <input type="text" id="match-id" placeholder="Enter Match ID (e.g., 121417)">
            </div>
            <button class="btn-scrape" onclick="fetchScorecard()">
                Get Scorecard
            </button>
        </div>
    </div>
    
    <div class="scorecard-preview" id="scorecard-preview" style="display: none;">
        <div class="preview-header">
            <h3 id="match-title">Scorecard</h3>
        </div>
        <div class="match-info" id="match-info"></div>
        <div class="preview-content" id="preview-content"></div>
    </div>
    
    <div class="loading" id="loading" style="display: none;">
        <div class="spinner"></div>
        <p>Loading scorecard...</p>
    </div>
    
    <div class="error-msg" id="error-msg" style="display: none;"></div>
</div>

<style>
.admin-page {
    padding: 20px;
}

.scrape-section, .scorecard-preview {
    background: transparent;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
}

.scrape-section h3, .scorecard-preview h3 {
    margin: 0 0 15px 0;
    color: #1a472a;
    font-size: 16px;
    border-bottom: 2px solid #1a472a;
    padding-bottom: 10px;
}

.input-group {
    display: flex;
    gap: 15px;
    align-items: flex-end;
    flex-wrap: wrap;
}

.input-row {
    display: flex;
    flex-direction: column;
    gap: 5px;
}

.input-row label {
    font-size: 12px;
    color: #666;
    font-weight: 600;
}

.input-row input {
    padding: 12px 15px;
    border: 2px solid #ddd;
    border-radius: 6px;
    font-size: 16px;
    width: 250px;
}

.input-row input:focus {
    border-color: #1a472a;
    outline: none;
}

.btn-scrape {
    background: linear-gradient(135deg, #1a472a, #2d6a4f);
    color: #fff;
    border: none;
    padding: 12px 25px;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
    font-size: 14px;
}

.btn-scrape:hover {
    background: linear-gradient(135deg, #2d6a4f, #1a472a);
}

.btn-scrape:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

.match-info {
    background: transparent;
    padding: 15px 0;
    margin-bottom: 15px;
}

.match-info p {
    margin: 5px 0;
    font-size: 14px;
}

.match-info .label {
    font-weight: 600;
    color: #555;
}

.preview-content {
    background: transparent;
    padding: 15px 0;
}

.innings-card {
    background: transparent;
    border-radius: 8px;
    margin-bottom: 20px;
    overflow: hidden;
}

.innings-header {
    background: linear-gradient(135deg, #1a472a, #2d6a4f);
    color: #fff;
    padding: 12px 15px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.innings-team {
    font-weight: 700;
    font-size: 15px;
}

.innings-score {
    font-size: 18px;
    font-weight: 700;
}

.innings-table {
    width: 100%;
    border-collapse: collapse;
}

.innings-table th, .innings-table td {
    padding: 8px 12px;
    text-align: left;
    border-bottom: 1px solid #eee;
    font-size: 13px;
}

.innings-table th {
    background: rgba(0,0,0,0.05);
    font-weight: 600;
    color: #333;
}

.live-status-text {
    background: linear-gradient(135deg, #ff5722, #ff9800);
    padding: 12px 15px;
    border-radius: 6px;
    color: #fff;
    font-weight: 600;
    margin-bottom: 15px;
    font-size: 15px;
    text-align: center;
}

.result-text {
    background: #e8f5e9;
    padding: 12px 15px;
    border-radius: 6px;
    color: #1a472a;
    font-weight: 600;
    margin-bottom: 15px;
    font-size: 15px;
}

.loading {
    text-align: center;
    padding: 40px;
}

.spinner {
    width: 40px;
    height: 40px;
    border: 4px solid #f3f3f3;
    border-top: 4px solid #1a472a;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto 15px;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.error-msg {
    background: #ffebee;
    color: #c62828;
    padding: 15px;
    border-radius: 6px;
    margin-top: 15px;
}

.no-data {
    text-align: center;
    padding: 30px;
    color: #888;
}

.section-title {
    font-weight: 600;
    font-size: 13px;
    color: #1a472a;
    padding: 10px 15px 5px;
    text-transform: uppercase;
    border-top: 1px solid #eee;
    margin-top: 5px;
}

.innings-card:first-child .section-title:first-of-type {
    border-top: none;
}

.dismissal-text {
    font-size: 11px;
    color: #666;
    max-width: 200px;
}

.fow-table td {
    font-size: 12px;
}

.innings-table th {
    font-size: 12px;
    text-transform: uppercase;
}

.innings-table td:nth-child(n+3) {
    text-align: center;
}

.innings-table th:nth-child(n+3) {
    text-align: center;
}

@media (max-width: 768px) {
    .input-group {
        flex-direction: column;
        align-items: stretch;
    }
    
    .input-row input {
        width: 100%;
    }
}
</style>

<script>
async function fetchScorecard() {
    const matchId = document.getElementById('match-id').value.trim();
    
    if (!matchId) {
        alert('Please enter Match ID');
        return;
    }
    
    const btn = document.querySelector('.btn-scrape');
    const loading = document.getElementById('loading');
    const preview = document.getElementById('scorecard-preview');
    const errorMsg = document.getElementById('error-msg');
    
    btn.disabled = true;
    btn.textContent = 'Loading...';
    loading.style.display = 'block';
    preview.style.display = 'none';
    errorMsg.style.display = 'none';
    
    try {
        const response = await fetch('/api/scrape/scorecard', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ match_id: matchId })
        });
        
        const data = await response.json();
        
        if (data.success && data.scorecard) {
            displayScorecard(data.scorecard);
        } else {
            errorMsg.textContent = data.message || 'Failed to fetch scorecard';
            errorMsg.style.display = 'block';
        }
    } catch (err) {
        errorMsg.textContent = 'Error: ' + err.message;
        errorMsg.style.display = 'block';
    } finally {
        btn.disabled = false;
        btn.textContent = 'Get Scorecard';
        loading.style.display = 'none';
    }
}

function displayScorecard(scorecard) {
    const preview = document.getElementById('scorecard-preview');
    const matchInfo = document.getElementById('match-info');
    const content = document.getElementById('preview-content');
    const title = document.getElementById('match-title');
    
    preview.style.display = 'block';
    
    // Match title - use team1 and team2 fields from scraper
    let teams = '';
    if (scorecard.team1 && scorecard.team2) {
        teams = scorecard.team1 + ' vs ' + scorecard.team2;
    } else if (scorecard.team1_name && scorecard.team2_name) {
        teams = scorecard.team1_name + ' vs ' + scorecard.team2_name;
    }
    title.textContent = teams || scorecard.match_title || 'Scorecard';
    
    // Match info
    let infoHtml = '';
    if (scorecard.series_name) {
        infoHtml += '<p><span class="label">Series:</span> ' + scorecard.series_name + '</p>';
    }
    if (scorecard.venue) {
        infoHtml += '<p><span class="label">Venue:</span> ' + scorecard.venue + '</p>';
    }
    if (scorecard.match_time) {
        infoHtml += '<p><span class="label">Time:</span> ' + scorecard.match_time + '</p>';
    }
    if (scorecard.match_format) {
        infoHtml += '<p><span class="label">Format:</span> ' + scorecard.match_format + '</p>';
    }
    if (scorecard.match_status) {
        infoHtml += '<p><span class="label">Status:</span> ' + scorecard.match_status + '</p>';
    }
    matchInfo.innerHTML = infoHtml;
    
    // Content
    let html = '';
    
    if (scorecard.live_status) {
        html += '<div class="live-status-text">' + scorecard.live_status + '</div>';
    }
    
    if (scorecard.result) {
        html += '<div class="result-text">' + scorecard.result + '</div>';
    }
    
    if (scorecard.innings && scorecard.innings.length > 0) {
        scorecard.innings.forEach((inn, idx) => {
            html += '<div class="innings-card">';
            html += '<div class="innings-header">';
            html += '<span class="innings-team">' + inn.team_name + '</span>';
            html += '<span class="innings-score">' + inn.total_score + ' (' + inn.overs + ' Ov)</span>';
            html += '</div>';
            
            // Batting
            if (inn.batting && inn.batting.length > 0) {
                html += '<div class="section-title">Batting</div>';
                html += '<table class="innings-table">';
                html += '<thead><tr><th>Batter</th><th>Dismissal</th><th>R</th><th>B</th><th>4s</th><th>6s</th><th>SR</th></tr></thead>';
                html += '<tbody>';
                inn.batting.forEach(bat => {
                    html += '<tr>';
                    html += '<td>' + bat.player + '</td>';
                    html += '<td class="dismissal-text">' + (bat.dismissal || 'not out') + '</td>';
                    html += '<td><strong>' + bat.runs + '</strong></td>';
                    html += '<td>' + bat.balls + '</td>';
                    html += '<td>' + bat.fours + '</td>';
                    html += '<td>' + bat.sixes + '</td>';
                    html += '<td>' + bat.strike_rate + '</td>';
                    html += '</tr>';
                });
                html += '</tbody></table>';
            }
            
            // Bowling
            if (inn.bowling && inn.bowling.length > 0) {
                html += '<div class="section-title">Bowling</div>';
                html += '<table class="innings-table">';
                html += '<thead><tr><th>Bowler</th><th>O</th><th>M</th><th>R</th><th>W</th><th>Econ</th></tr></thead>';
                html += '<tbody>';
                inn.bowling.forEach(bowl => {
                    html += '<tr>';
                    html += '<td>' + bowl.bowler + '</td>';
                    html += '<td>' + bowl.overs + '</td>';
                    html += '<td>' + bowl.maidens + '</td>';
                    html += '<td>' + bowl.runs + '</td>';
                    html += '<td><strong>' + bowl.wickets + '</strong></td>';
                    html += '<td>' + bowl.economy + '</td>';
                    html += '</tr>';
                });
                html += '</tbody></table>';
            }
            
            // Fall of Wickets
            if (inn.fall_of_wickets && inn.fall_of_wickets.length > 0) {
                html += '<div class="section-title">Fall of Wickets</div>';
                html += '<table class="innings-table fow-table">';
                html += '<thead><tr><th>Player</th><th>Score</th><th>Over</th></tr></thead>';
                html += '<tbody>';
                inn.fall_of_wickets.forEach(fow => {
                    html += '<tr>';
                    html += '<td>' + fow.player + '</td>';
                    html += '<td>' + fow.score + '</td>';
                    html += '<td>' + fow.over + '</td>';
                    html += '</tr>';
                });
                html += '</tbody></table>';
            }
            
            html += '</div>';
        });
    } else {
        html += '<div class="no-data">Match has not started yet or no scorecard data available</div>';
    }
    
    content.innerHTML = html;
}

// Enter key support
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('match-id').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            fetchScorecard();
        }
    });
});
</script>
{% endblock %}
